!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Bipes=t()}(this,(function(){"use strict";let e={mkdir:{cmd:(e,t)=>`import os; os.mkdir("${e}/${t}")\r`,reg:/import os; os\.mkdir\("(.*)\/(?:.*)"\)/},exec:{cmd:e=>`exec(open("${e}").read(),globals())\r`,reg:/exec\(open\("(.*)"\).read\(\)\.globals\(\)\)/},rm:{cmd:e=>`import os; os.remove("${e}")\r`,reg:/os\.remove\("(.*)\/(.*)"\)/},write:{cmd:(e,t)=>`f=open("${e}",'w')\nf.write('${t}')\nf.close()\n`,reg:/=== f=open\("(.*)\/(?:.*)",'w'\)/},preopen:{cmd:e=>`import uos, sys; uos.stat("${e}")\r`},open:{cmd:e=>`with open("${e}", 'rb') as infile:\n\twhile True:\n\t\tresult = infile.read(32)\n\t\tif result == b'':\n\t\t\tbreak\n\t\tlen = sys.stdout.write(result)\n`,reg:/with open\("(.*)", 'rb'\) as infile:/},ls:{cmd:e=>`import os; os.listdir('${e}')\r`,reg:/\import os; os\.listdir\('(.*)'\)/},uname:{cmd:()=>"import os; os.uname()\r",reg:/import os; os\.uname\(\)/,reg_str:/nodename='(.*?)', release='(.*?)'/},error:{reg:/OSError: ([0-9]{1,})/}},t={map:{MicroPython:e,CircuitPython:{mkdir:{cmd:(e,t)=>`import os; os.mkdir("${e}/${t}")\r`,reg:/import os; os\.mkdir\("(.*)\/(?:.*)"\)/},exec:{cmd:e=>`exec(open("${e}").read(),globals())\r`,reg:/exec\(open\("(.*)"\).read\(\)\.globals\(\)\)/},rm:{cmd:e=>`import os; os.remove("${e}")\r`,reg:/os\.remove\("(.*)\/(.*)"\)/},write:{cmd:(e,t)=>`f=open("${e}",'w')\nf.write('${t}')\nf.close()\n`,reg:/=== f=open\("(.*)\/(?:.*)",'w'\)/},preopen:{cmd:e=>`import uos, sys; uos.stat("${e}")\r`},open:{cmd:e=>`with open("${e}", 'rb') as infile:\n\twhile True:\n\t\tresult = infile.read(32)\n\t\tif result == b'':\n\t\t\tbreak\n\t\tlen = sys.stdout.write(result)\n`,reg:/with open\("(.*)", 'rb'\) as infile:/},ls:{cmd:e=>`import os; os.listdir('${e}')\r`,reg:/\import os; os\.listdir\('(.*)'\)/},uname:{cmd:()=>"import os; os.uname()\r",reg:/import os; os\.uname\(\)/,reg_str:/nodename='(.*?)', release='(.*?)'/},error:{reg:/OSError: ([0-9]{1,})/}},Snek:e},get languages(){return Object.keys(this.map)},current:void 0,language(e){for(let t in this.map)if(e==t)return this.current=this.map[t],e;return this.current=this.map.MicroPython,"MicroPython"},get mkdir(){return this.current.mkdir},get exec(){return this.current.exec},get rm(){return this.current.rm},get write(){return this.current.write},get preopen(){return this.current.preopen},get open(){return this.current.open},get ls(){return this.current.ls},get uname(){return this.current.uname},get error(){return this.current.error}};class s{constructor(e,t){if(this.$,"string"!=typeof e)return void(this.$=e);let s=["innerText","className","id","title","innerText","value","tabIndex","role","href","ariaPressed","preload","controls","autoplay","src","placeholder","htmlFor","type","autocomplete","name","accept","disabled","innerHTML"];if(this.$=document.createElement(e),"object"==typeof t)for(const e in t)s.includes(e)?this.$[e]=t[e]:this.$.dataset[e]=t[e]}set innerText(e){this.$.innerText=e}get innerText(){return this.$.innerText}get height(){return this.$.offsetHeight}get width(){return this.$.offsetWidth}get id(){return this.$.id}set id(e){this.$.id=e}get value(){return this.$.value}set value(e){this.$.value=e}get src(){return this.$.src}set src(e){this.$.src=e}focus(){this.$.focus()}get classList(){return this.$.classList}get style(){return this.$.style}onchange(e,t,s){return this.$.onchange=i=>{void 0===s?t.apply(e,[i]):s.constructor==Array&&(s.push(i),t.apply(e,s))},this}onclick(e,t,s){return this.$.onclick=i=>{void 0===s?t.apply(e,[i]):s.constructor==Array&&(s.push(i),t.apply(e,s))},this}onup(e,t,s){return this.$.addEventListener("mouseup",(i=>{void 0===s?t.apply(e,[i]):s.constructor==Array&&(s.push(i),t.apply(e,s))})),this}ondown(e,t,s){return this.$.addEventListener("mousedown",(i=>{void 0===s?t.apply(e,[i]):s.constructor==Array&&(s.push(i),t.apply(e,s))})),this}onmove(e,t,s){return this.$.addEventListener("mousemove",(i=>{void 0===s?t.apply(e,[i]):s.constructor==Array&&(s.push(i),t.apply(e,s))})),this}onevent(e,t,s,i){return this.$.addEventListener(e,(e=>{void 0===i?s.apply(t,[e]):i.constructor==Array&&(i.push(e),s.apply(t,i))})),this}append(e){return e.constructor!=Array&&(e=[e]),e.forEach((e=>{/HTML(.*)Element/.test(e.constructor.name)?this.$.appendChild(e):"object"==typeof e&&/HTML(.*)Element/.test(e.$)&&this.$.appendChild(e.$)})),this}delete(){this.$.remove()}removeChilds(){let e=this.$.lastElementChild;for(;e;)this.$.removeChild(e),e=this.$.lastElementChild;return this}static get(e,t){return void 0===(t=t instanceof s?t.$:t)?document.querySelector(e):t.querySelector(e)}static getAll(e,t){return"object"==typeof(t=t instanceof s?t.$:t)?t.querySelectorAll(e):get(t).querySelectorAll(e)}static switchState(e,t){let i=null!=t?t:"on";(e=e instanceof s?e.$:e).classList.contains(i)?e.classList.remove(i):e.classList.add(i)}static UID(){return(+new Date).toString(36)+Math.random().toString(36).substr(2)}static prototypeDetails(e){let t=new s("summary",{innerText:e.innerText}),i=new s("details",{id:e.id,name:e.id}).append(t);return null!=e.onevent&&e.onevent.forEach((e=>{e.args.push(i.$),t.onevent(e.event,e.self,e.fun,e.args)})),i}static prototypeInputFile(e){return new s("label",{htmlFor:`${e.id}_input`,id:e.id,className:e.className,innerText:e.innerText}).append(new s("input",{id:`${e.id}_input`,type:"file"}))}static prototypeCheckSwitch(e){let t=new s("input",{id:e.id,name:e.id,className:"checkswitch",type:"checkbox",value:!1});return[t,new s("div",{className:e.className}).append([new s("div").append([new s("label",{className:"checkswitch",htmlFor:e.id,innerText:e.innerText}).append([t,new s("span")])])])]}static prototypeDownload(e,t){let s,i=/.*\.(py|xml|csv|json|svg|png)$/;if(!i.test(e))return;let n=e.match(i)[1];switch(e=e.replaceAll("/","-").replaceAll(" ","_").toLowerCase(),n){case"xml":s="data:x-application/xml;charset=utf-8,"+encodeURIComponent(t);break;case"py":s="data:text/python;charset=utf-8,"+encodeURIComponent(t);break;case"json":s="data:text/json;charset=utf-8,"+encodeURIComponent(t);break;case"csv":s="data:text/csv;charset=utf-8,"+encodeURIComponent(t);break;case"svg":s="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(t);break;case"png":s=t}let r=document.createElement("a");r.setAttribute("href",s),r.setAttribute("download",e),r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r)}static setSelected(e,t){for(var s=0;s<e.$.options.length;s++)if(e.$.options[s].text==t)return void(e.$.options[s].selected=!0)}static lazyUpdate(e,t,i,n){n=null==n?"innerText":n;let r=s.get(`[data-uid='${t}']`,e);for(const e in i)s.get(`#${e}`,r)[n]=i[e]}}class i{constructor(){}static off(e,t,s){e.classList.remove("on"),s||(s=250),setTimeout((()=>{e.classList.remove("ani","on"),null!=t&&t()}),s)}static on(e,t){e.classList.add("ani"),t||(t=250),setTimeout((()=>{e.classList.add("ani","on")}),t)}}class n{constructor(e,t){this.ref=t,this.mdTimestamp;let i=this.$={};i.contextMenu=e,i.contextMenu.$.id="contextMenu",i.contextMenu.$.classList.add("popup"),i.contextMenu.onclick(this,this.close).onevent("contextmenu",this,this.close).onevent("mousedown",this,(e=>{this.mdTimestamp=+new Date})),i.wrapper=new s("div"),i.contextMenu.append(i.wrapper)}close(e){null!=e&&e.preventDefault(),null!=e&&"contextMenu"!=e.target.id||(+new Date-this.mdTimestamp<250||null==e)&&(this.$.wrapper.$.style.height="0px",i.off(this.$.contextMenu.$,void 0,125),setTimeout((()=>{this.$.wrapper.removeChilds()}),125))}open(e,t){let n=this.$,r=window.innerHeight<t.y+2*e.length*16?t.y-16*(2*e.length-1+1):t.y-16,a=window.innerWidth<t.x+160?t.x-176:t.x-16;n.wrapper.$.style.margin=`${r}px auto auto ${a}px`,setTimeout((()=>{n.wrapper.$.style.height=16*(2*e.length+.25)+"px"}),125),n.wrapper.removeChilds();let o=[];e.forEach((e=>{if("upload"===e.id){let t=new s("input",{type:"file",accept:e.accept});e.args.push(t.$),t.onevent("change",this.ref,e.fun,e.args),o.push(new s("button",{className:"icon text",id:e.id,innerText:e.innerText}).onclick(this.ref,(()=>{t.$.click()})))}else o.push(new s("button",{className:"icon text",id:e.id,innerText:e.innerText}).onclick(this.ref,e.fun,e.args))})),n.wrapper.append(o),setTimeout((()=>{o[0].$.focus()}),125),i.on(n.contextMenu.$,125)}oninput(e,t){let i=this.$;i.wrapper.removeChilds(),i.wrapper.$.style.height="76px";let n=new s("input",{placeholder:e.placeholder,value:null==e.value?"":e.value}),r=new s("form").onevent("submit",this,t,[n.$]).append(n);i.wrapper.append([new s("h3",{innerText:e.title}),r]),n.$.focus()}}class r{static UID(){return this.randomChar()+(+new Date).toString(36)+Math.random().toString(36).substring(3)}static SID(){return this.randomChar()+Math.random().toString(36).substring(3,8)}static randomChar(){const e="abcdefghijklmnopqrstuvwxyz";return e[Math.floor(26*Math.random())]}static fromUrl(e){let t=new URLSearchParams(document.location.search);return null==t.get(e)?this.urlDefaults(e):this.urlValidParams(e,t.get(e))}static urlDefaults(e){if("theme"===e)return"light"}static urlValidParams(e,t){if("theme"===e)return["dark","light"].includes(t)?t:this.urlDefaults(e)}static encodeQueryData(e){const t=[];for(let s in e)t.push(`${encodeURIComponent(s)}=${encodeUDIComponent(e[s])}`);return t.join("&")}static pushUnique(e,t,s){let i=[];return t.forEach((t=>{e.some((e=>e[s]==t[s]))||(e.push(t),i.push(t))})),i}static getMin(e,t,s){return e.length&&e.reduce((function(e,i){return s?parseFloat(e[t])<parseFloat(i[t])?e:i:e[t]<i[t]?e:i}))||null}static getMax(e,t,s){return e.length&&e.reduce((function(e,i){return s?parseFloat(e[t])>parseFloat(i[t])?e:i:e[t]>i[t]?e:i}))||null}static prettyEditedAt(e,t){return e=t?e:1e3*e,`${Msg.EditedAt} ${new Date(e).toLocaleString()}`}static firstUpper(e){return e.charAt(0).toUpperCase()+e.slice(1)}static format(e){let t=Array.prototype.slice.call(e,1);return e[0].replace(/{(\d+)}/g,((e,s)=>void 0!==t[s]?t[s]:e))}static colors(e){return[["rgba(0,0,255,1.0)","rgba(155,0,155,1.0)","rgba(0,255,0,1.0)","rgba(255,0,0,1.0)","rgba(56,95,70,1.0)","rgba(318,95,70,1.0)"][e],["rgba(106,168,251,0.5)","rgba(123,73,173,0.5)","rgba(106,251,116,0.5)","rgba(251,106,106,0.5","rgba(56,95,70,0.5)","rgba(318,95,70,0.5)"][e]]}static round(e,t){return Math.round((e+Number.EPSILON)*Math.pow(10,t))/Math.pow(10,t)}static transpose(e){for(var t=0;t<e.length;t++)for(var s=0;s<t;s++){const i=e[t][s];e[t][s]=e[s][t],e[s][t]=i}return e.forEach(((t,s)=>{if(!t.some((e=>null!=e)))return e.splice(s)})),e}static randomColor(){let e=parseInt(255*Math.random()),t=255-e,s=255-e-t;return[`rgba(${e},${t}.${s},0.8)`,`rgba(${e},${t}.${s},1.0)`]}}class a{static async do(e,t){const s=await fetch(`${window.location.href.match("^(.*)/ide")[1]}/api/${e}`,{method:"Post",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw new Error(s.status);return await s.json()}}function o(e){let t={};for(let s in e)for(let i in e[s])bipes.page.hasOwnProperty(s)?t[`${s}_${i}`]=e[s][i]:t[`${s}_${i}`]=()=>{};return t}function c(e,t,s,n,a){let o=2==t?1:2,c=e.current,h=(e,t)=>{s[e].deinit(),s[e].nav.classList.remove("on"),1==t&&s[e].section.classList.add("_pos1"),2==t&&s[e].section.classList.add("_pos2"),s[e].section.classList.remove(`pos${t}`),i.off(s[e].section)},d=(t,n)=>{if(s[t].init(),s[t].nav.classList.add("on"),i.on(s[t].section),s[t].section.classList.remove("_pos1","_pos2"),0!=n&&s[t].section.classList.add(`pos${n}`),2!=n&&a&&!e.isLocal){let e=new URL(location.href);e.searchParams.set("page",t),history.pushState({},"",e)}l(),document.title=`${Msg["Page"+r.firstUpper(t)]} - BIPES`};if(0==t)return d(n,0),void(e.current=[n,"",""]);if(c[o]!=n){if(c[0]!=n||""!=c[1]||""!=c[2])return 1==t&&""!=c[0]?(h(c[0],0),c[0]=n,void d(c[0],0)):1==t&&c[t]==n&&""!=c[o]?(h(c[o],o),s[c[t]].section.classList.remove(`pos${t}`),e.current=[n,"",""],void l()):2==t&&c[t]==n&&""!=c[o]?(h(c[t],t),s[c[o]].section.classList.remove(`pos${o}`),e.current=[c[o],"",""],void l()):c[t]!=n&&""==c[0]?(""!=c[t]&&h(c[t],t),d(n,t),e.current[t]=n,void l()):2==t&&c[t]!=n&&""!=c[0]?(s[c[0]].section.classList.add("pos1"),d(n,2),e.current=["",c[0],n],void l()):void 0}else if(s[c[t]].section.classList.remove(`pos${t}`),s[c[t]].section.classList.add(`pos${o}`),s[c[o]].section.classList.remove(`pos${o}`),s[c[o]].section.classList.add(`pos${t}`),e.current=["",c[2],c[1]],!e.isLocal){let t=new URL(location.href);t.searchParams.set("page",e.current[1]),history.pushState({},"",t)}}function h(e,t){let s=e?1:0;document.URL.split("#").length>1&&document.URL.split("#")[1];let i=new URLSearchParams(window.location.search);null!=i.get("page")?(c.apply(t[i.get("page")],[d,s,t,i.get("page")]),l()):c.apply(t.blocks,[d,s,t,"blocks"])}function l(){d.portrait=window.innerHeight>window.innerWidth,d.current.forEach((e=>{""!=e&&window.bipes.page.hasOwnProperty(e)&&"function"==typeof window.bipes.page[e].resize&&setTimeout((()=>{window.bipes.page[e].resize()}),125)}))}let d=new class{constructor(){this.current=["","",""],this.portrait=!1,this.isLocal="file:"==window.location.protocol;let e=this.$={};e.nav=s.get("nav"),e.menu=s.get("#menu",e.nav),e.panels=s.get("#panels",e.nav),e.menu.onclick=()=>{s.switchState(this.$.nav),e.langugeDropdown},document.body.className=r.fromUrl("theme")}init(e){for(let e in bipes.page){let t=s.get(`a#${e}`,this.$.panels);t.innerText=Msg[`Page${r.firstUpper(e)}`],t.title=Msg[`Page${r.firstUpper(e)}`],t.onauxclick=e=>{if(e.preventDefault(),2!==e.which)return;let t=new URL(location.href);t.searchParams.set("page",e.target.id),open(t,"_blank").focus()},t.onclick=t=>{t.preventDefault(),c.apply(window.bipes.page[e],[this,1,bipes.page,e,!0])},t.addEventListener("contextmenu",(t=>{t.preventDefault(),c.apply(window.bipes.page[e],[this,2,bipes.page,e,!0])})),bipes.page[e].section=s.get(`section#${e}`),bipes.page[e].nav=t}onpopstate=()=>{h(!0,bipes.page)},onresize=()=>{l()},h(!1,bipes.page),bipes.channel.connectPipes();for(let e in bipes.page)"function"==typeof bipes.page[e].connectPipes&&bipes.page[e].connectPipes();new s(s.get("div#status-bar #extra")).append([new s("button",{className:"dark"===new URL(location.href).searchParams.get("theme")?"status-icon on":"status-icon",id:"theme",title:Msg.ChangeTheme}).onclick(this,(()=>{let e=new URL(location.href);e.searchParams.set("theme","dark"===e.searchParams.get("theme")?"light":"dark"),location.href=e}))]);let t=[];for(const i in e)t.push(new s("option",{innerText:e[i],value:i}));this.$.languageDropdown=new s("select",{title:Msg.Language}).append(t).onevent("change",this,(()=>{let e=new URL(location.href);e.pathname=`${e.pathname.match("^(.*)/ide")[1]}/ide-${this.$.languageDropdown.value}`,location.href=`${e}`})),new s(s.get("div#status-bar #extra")).append([new s("span",{innerText:Msg.Language,className:"status-icon",id:"language"}).append(this.$.languageDropdown)]),this.$.languageDropdown.$.value=document.documentElement.lang,shortcut.add("Shift+Ctrl+R",(()=>{}));let i=1,n=document.createEvent("HTMLEvents");n.initEvent("contextmenu",!0,!1),s.getAll("a",this.$.nav).forEach((e=>{i<=9&&(shortcut.add(`Alt+${i}`,(()=>{e.click()})),shortcut.add(`Ctrl+Alt+${i}`,(()=>{e.dispatchEvent(n)}))),i++}))}};let p=new class{constructor(){this.name="command",this.map={},this.pipe=new BroadcastChannel("main"),this.pipe.onmessage=e=>{this.mux(e)},this.tabUID=r.UID(),this.clients=[],this.add(this,{clientsChanged:this.clientsChanged},!0),this._clientConnect(),window.addEventListener("unload",(()=>{this._clientDisconnect(),this.pipe.close()}))}add(e,t,s){let i="";e instanceof Array?(e.forEach((e=>{i+=`_${e.name}`})),i=i.substr(1)):i=e.name;for(let e in t){let n=`${i}_${e}`;this.map[n]={},this.map[n].fun=(e,t)=>{let s=bipes.page;"channel"==t[0]?s=bipes.channel:"command"==t[0]?s=bipes.command:t[0].forEach((e=>{s=s[e]})),t.shift(),this.map[n].callback.apply(s,t),localStorage.removeItem(e)},this.map[n].callback=t[e],this.map[n].skipMain=1==s}}remove(e,t){"Array"!=t.constructor.name&&(t=[t]),t.forEach((t=>{let s=`${e.name}_${t}`;window.removeEventListener("storage",this.map[s].fun),delete this.map[s]}))}dispatch(e,t,s){e instanceof Array||(e=[e]);let i="",n=[];e.forEach((e=>{i+=`_${e.name}`})),i=i.substr(1),i+=`_${t}`,this.map.hasOwnProperty(i)?(0==this.map[i].skipMain&&this.map[i].callback.apply(e[e.length-1],s),e.forEach((e=>{n.push("String"==e.constructor.name?e:e.name.toLowerCase())})),s.unshift(n),s=s.map((e=>{if(null!=e)return"Uint8Array"===e.constructor.name?{Uint8Array:Array.from(e)}:e})),this.pipe.postMessage(`["${r.SID()}_${i}",${JSON.stringify(s)}]`)):console.error(`CommandBroker: ${i} does not exist in the command map.`)}mux(e){let t=JSON.parse(e.data),s=t[0],i=t[1];i=i.map((e=>"object"==typeof e&&null!==e&&"Uint8Array"===Object.keys(e)[0]?new Uint8Array(e.Uint8Array):e));const n=s.substring(7);this.map.hasOwnProperty(n)&&this.map[n].fun(s,i)}_clientConnect(){null==localStorage.clients||"[]"==localStorage.clients?(this.clients=[this.tabUID],localStorage.setItem("clients",JSON.stringify(this.clients))):(this.clients=JSON.parse(localStorage.clients),this.clients.push(this.tabUID),localStorage.setItem("clients",JSON.stringify(this.clients)),this.clients.length>1&&this.dispatch(this,"clientsChanged",[this.tabUID,!0]))}_clientDisconnect(){this.clients.splice(this.clients.indexOf(this.tabUID),1),localStorage.setItem("clients",JSON.stringify(this.clients)),this.dispatch(this,"clientsChanged",[this.tabUID,!1])}clientsChanged(e,t){t?this.clients.push(e):this.clients.splice(this.clients.indexOf(e),1)}};let u=new class{constructor(){}keys(e){let t=[];return Object.keys(localStorage).filter((t=>e.test(t))).forEach((s=>{t.push(s.match(e)[1])})),t}fetch(e,t){let s;return s="RegExp"==typeof e?this.fetchAll(e)[0]:localStorage[e],null!=s&&""!=s&&(t?JSON.parse(s):s)}has(e){return!!localStorage.hasOwnProperty(e)&&(""!=localStorage[e]||(this.remove(e),!1))}set(e,t,s){return null==t&&(t="[]"),localStorage.setItem(e,s?JSON.stringify(t):t),t}remove(e){localStorage.removeItem(e)}};function g(e){this.name="WebSerial",this.port,this.config={packetSize:0},this.encoder=new TextEncoder,this.parent=e,this.connect=(e,t)=>{if(null==navigator.serial)return!1;t=parseInt(t),navigator.serial.requestPort().then((s=>{this.port=s,this.port.open({baudRate:[t]}).then((()=>{const t=new WritableStream({write(e){"string"==typeof e&&window.bipes.channel.inString(e)},abort(e){window.bipes.channel._disconnected()}});return this.port.readable.pipeThrough(new TextDecoderStream).pipeTo(t),this.parent._connected("webserial",e),!0})).catch((t=>{if(console.error(t),11==t.code)return this.parent._connected("webserial",e),!0}))})).catch((e=>(console.error(e),!1)))},this.disconnect=e=>{const t=this.port.writable.getWriter();t.close().then((()=>(this.port.close().then((()=>{this.port=void 0})).catch((s=>{console.error(s),1==e&&(t.abort(),this.parent._disconnected(),this.port=void 0)})),!0)))},this.watch=()=>{if(this.port&&this.port.writable&&0==this.port.writable.locked&&0==this.parent.lock&&this.parent.input.length>0){if(this.parent.isDirty())return;try{this.parent.lock=!0,this.write(this.parent.input[0]),this.parent.input.shift()}catch(e){console.error(e)}}},this.write=async e=>{let t;"Array"!=e.constructor.name&&(e=[e]);for(const[s,i]of e.entries()){switch(i.constructor.name){case"Uint8Array":t=i;break;case"String":case"Number":t=this.encoder.encode(i)}let n=((e,t)=>Array.from({length:Math.ceil(e.length/t)},((s,i)=>e.slice(i*t,i*t+t))))(t,1);if(this.port&&this.port.writable&&null!=t){const e=this.port.writable.getWriter();for(const t of n)await e.write(t);e.releaseLock()}this.parent.pipe.prompt_setLoading(s,e.length-1)}0==this.parent.callbacks.length&&(this.parent.lock=!1),this.parent.pipe.prompt_endLoading()}}function m(e){this.name="WebSocket",this.parent=e,this.ws,this.encoder=new TextEncoder,this.config={packetSize:10},this.connect=(e,t)=>{if(null==WebSocket)return!1;this.ws=new WebSocket(t.url),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{this.ws.send(`${t.passwd}\n\n`),this.parent._connected("websocket",e),this.ws.onmessage=e=>{e.data instanceof ArrayBuffer&&window.bipes.channel.inArrayBuffer(e.data),"string"==typeof e.data&&(window.bipes.channel.inString(e.data),e.data.includes("Access denied")&&bipes.page.notification.send("Wrong board password"))}},this.ws.onclose=()=>{null!=this.parent.current&&this.parent._disconnected()}},this.disconnect=e=>{this.ws.close(),this.parent._disconnected()},this.watch=()=>{if(0==this.ws.bufferedAmount&&0==this.parent.lock&&this.parent.input.length>0){if(this.parent.isDirty())return;try{this.parent.lock=!0,this.write(this.parent.input[0])}catch(e){console.error(e)}}},this.write=async e=>{"Array"!=e.constructor.name&&(e=[e]);let t,s=e.length;0!==e.length&&(t=setInterval((()=>{0===this.ws.bufferedAmount&&void 0!==e[0]&&("Uint8Array"===e[0].constructor.name?(this.ws.send(e[0]),e.shift(),this.parent.lock=!1):["String","Number"].includes(e[0].constructor.name)&&(this.ws.send(e[0]),e.shift())),this.parent.pipe.prompt_setLoading(s-e.length,s),0===e.length&&(clearInterval(t),this.parent.input.shift(),0==this.parent.callbacks.length&&(this.parent.lock=!1),this.parent.pipe.prompt_endLoading())}),50))}}function f(e){this.name="WebBluetooth",this.parent=e,this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.streaming,this.bleDevice,this.nusService=void 0,this.txCharacteristic=void 0,this.rxCharacteristic=void 0,this.config={ServiceUUID:"6e400001-b5a3-f393-e0a9-e50e24dcca9e",RXUUID:"6e400002-b5a3-f393-e0a9-e50e24dcca9e",TXUUID:"6e400003-b5a3-f393-e0a9-e50e24dcca9e",packetSize:0},this.connect=e=>{if(null==navigator.bluetooth)return!1;navigator.bluetooth.requestDevice({optionalServices:[this.config.ServiceUUID],acceptAllDevices:!0}).then((e=>(this.bleDevice=e,console.log(`Found ${e.name}\nConnecting to GATT Server...`),this.bleDevice.addEventListener("gattserverdisconnected",this.disconnect.bind(this)),bleDevicec.gatt.connect()))).then((e=>(console.log("Locate NUS service"),e.getPrimaryService(this.config.ServiceUUID)))).then((e=>{this.nusService=e,console.log(`Found NUS service: ${e.uuid}`)})).then((()=>(console.log("Locate RX characteristic"),this.nusService.getCharacteristic(this.config.RXUUID)))).then((e=>{this.rxCharacteristic=e,console.log("Found RX characteristic")})).then((()=>(console.log("Locate TX characteristic"),this.nusService.getCharacteristic(this.config.TXUUID)))).then((e=>{this.txCharacteristic=e,console.log("Found TX characteristic")})).then((()=>(console.log("Enable notifications"),this.txCharacteristic.startNotifications()))).then((()=>{this.txCharacteristic.addEventListener("characteristicvaluechanged",(e=>{this.parent.inString(this.decoder.decode(e.target.value))})),this.parent._connected("webluetooth",e)})).catch((e=>{this.parent._disconnected(),this.bleDevice&&this.bleDevice.gatt.connected&&this.bleDevice.gatt.disconnect()}))},this.disconnect=e=>{this.bleDevice||this.bleDevice.gatt.connected&&this.bleDevice.gatt.disconnect(),this.bleDevice=void 0,this.nusService=void 0,this.txCharacteristic=void 0,this.rxCharacteristic=void 0,this.parent._disconnected()},this.watch=()=>{if(this.bleDevice&&this.bleDevice.gatt.connected&&this.parent.input.length>0&&!this.streaming&&0==this.parent.lock){if(this.parent.isDirty())return;try{this.parent.lock=!0,this.write(this.parent.input[0])}catch(e){console.error(e)}}},this.write=async e=>new Promise(((t,s)=>{this.streaming=!0;const i=this.encoder.encode(e);this.rxCharacteristic.writeValue(i).then((()=>{0==this.parent.callbacks.length&&(this.parent.lock=!1),this.parent.input.shift(),this.parent.input.length>0?this.write(this.parent.input[0]):this.streaming=!1})).catch((e=>(console.error(e),Promise.resolve().then((()=>this.delayPromise(500))).then((()=>this.rxCharacteristic.writeValue(i))).catch((e=>{console.error(e),"NetworkError: Failed to execute 'writeValue' on 'BluetoothRemoteGATTCharacteristic': GATT Server is disconnected. Cannot perform GATT operations. (Re)connect first with `device.gatt.connect`."==e&&console.error("Lost Bluetooth connection.")})))))})),this.delayPromise=e=>new Promise((t=>{setTimeout(t,e)}))}let w=new class{constructor(){this.name="channel",this.current,this.pipe={},this.currentProtocol,this.input=[],this.output="",this.watcher,this.lock=!1,this.dirty=!1,this.callbacks=[],this.webserial=new g(this),this.websocket=new m(this),this.webbluetooth=new f(this),this.targetDevice,this.ping={timer:void 0,on:!1},p.add(this,{push:this.push,rawPush:this.rawPush}),window.addEventListener("beforeunload",(()=>{null!=this.current&&this.disconnect(!0)})),shortcut.add("Shift+Ctrl+S",(()=>{p.dispatch(this,"rawPush",["",this.targetDevice,[],this.tabUID])}))}renewPing(){clearTimeout(this.ping.timer),this.ping.timer=setTimeout((()=>{!1===this.ping.on&&window.bipes.page.device.unresponsive(this.targetDevice)}),2e3)}connectPipes(){this.pipe=o({prompt:{write:e=>{bipes.page.prompt.write(e)},on:()=>{bipes.page.prompt.on()},off:()=>{bipes.page.prompt.off()},setLoading:(e,t)=>{bipes.page.prompt.setLoading(e,t)},endLoading:()=>{bipes.page.prompt.endLoading()}},dashboard:{write:e=>{bipes.page.dashboard.write(e)}},device:{unuse:e=>{bipes.page.device.unuse(e)},reconnect:e=>{bipes.page.device.reconnect(e)}}})}push(e,t,s,i){if(null!=this.targetDevice){if(null!=this.current&&this.targetDevice==t){if(this.renewPing(),null!=s&&"Array"==s.constructor.name){let t,n=window.bipes.page;if(0==s.length)t=()=>{};else{for(let e=0;e<s.length-1;e++)n=n[s[e]];t=n[s[s.length-1]]}this.callbacks.push({self:n,fun:t,cmd:e}),i&&(this.callbacks[this.callbacks.length-1].uid=i)}if("Uint8Array"==e.constructor.name)this.input.push([e]);else if("string"==typeof e&&0!=this.current.config.packetSize){let t=new RegExp(`(.|[\r]){1,${this.current.config.packetSize}}`,"g");this.input.push([...e.match(t)]),console.log([...e.match(t)])}else this.input.push(e)}}else bipes.page.notification.send(Msg.NotConnectedWarning)}rawPush(e,t){null!=this.targetDevice?null!=this.current&&this.targetDevice==t&&(this.dirty=!0,this.current.write(e)):bipes.page.notification.send(Msg.NotConnectedWarning)}switch(e){this.diconnect(),this.connect(e)}connect(e,t,s){switch(e){case"websocket":case"webserial":this[e].connect(t,s);break;default:this[e].connect(t)}}_connected(e,t){this.targetDevice=r.UID(),this.current=this[e],this.currentProtocol=this.current.name,this.watcher=setInterval(this.current.watch.bind(this.current),50),this.pipe.prompt_on(),this.pipe.prompt_write(`\r\n[31mConnected with ${this.currentProtocol}![m\r\n`),this.push("\r\n",this.targetDevice),"object"==typeof t&&"function"==typeof t[1]&&t[1].apply(t[0])}disconnect(e){this.current.disconnect(e)&&this._disconnected()}_disconnected(){clearInterval(this.watcher),this.output="",this.callbacks=[],this.current=void 0;let e=this.targetDevice,t=this.currentProtocol;this.currentProtocol="",this.pipe.device_unuse(e),this.pipe.prompt_off(),this.pipe.prompt_write(`\r\n[31mDisconnected from ${t}![m\r\n`),this.targetDevice=void 0,this.pipe.device_reconnect(t)}handleCallback(e){e=this.interpretBackspace(e.replaceAll("\t","    "));let t=this.callbacks[0];if(!t.hasOwnProperty("skip")&&!/^[\x00-\x7F]{1}$/.test(t.cmd)){if(t.cmd=t.cmd.replaceAll("\t","    "),""==t.cmd[0]&&(t.cmd=this.emulatePasteMode(t.cmd)),e.substring(0,t.cmd.length)!=t.cmd)return console.error("Channel: callback's commands checkup failed"),this.callbacks=[],this.output="",this.lock=!1,!0;e=e.substr(t.cmd.length);try{t.uid?t.fun.apply(t.self,[e,t.cmd,t.uid]):t.fun.apply(t.self,[e,t.cmd])}catch(e){console.error(e)}}this.output="",this.lock=!1,this.callbacks.shift()}interpretBackspace(e){let t=[];e=e.replaceAll("\b[K","\b");for(let s of e)"\b"==s?t.pop():t.push(s);return t.join("")}emulatePasteMode(e){return`\r\npaste mode; Ctrl-C to cancel, Ctrl-D to finish\r\n=== ${(e=e.substring(1,e.length-1)).replaceAll(/\t/g,"    ")}`}pasteMode(e){return null!=this.current&&"WebSocket"==this.current.name&&(e=e.replaceAll("\n","\r\n")),`${e}`}isDirty(){return!!this.dirty&&(this.current.write(""),this.dirty=!1,this.callbacks.unshift({skip:!0}),!0)}inArrayBuffer(e){let t=new Uint8Array(e);if(this.callbacks.length>0){let e=this.callbacks[0];if(2==t.length&&t[0]|!(t[1]<<8))return console.log("Channel: End of text detected"),void(e.cmd[0]=3);try{e.uid?e.fun.apply(e.self,[t,e.cmd,e.uid]):e.fun.apply(e.self,[t,e.cmd])}catch(e){console.error(e)}this.callbacks.shift()}}inString(e){this.output+=e,this.pipe.prompt_write(e),this.pipe.dashboard_write(e),this.ping.on=!0,">>> "==this.output.substring(this.output.length-4)&&(this.output=this.output.substring(0,this.output.length-4),this.dirty=!1,this.callbacks.length>0?this.handleCallback(this.output):(this.output="",this.lock=!1))}};class b{constructor(){this.div=new s("div"),this.dom=new s("div",{id:"prompt",className:"progress-bar"}).append(this.div),document.body.append(this.dom.$)}load(e,t){this.dom.classList.contains("on")||this.dom.classList.add("on");let s=100*e/t;this.div.style.width=s+"%"}end(){this.dom.classList.remove("on"),this.div.style.width="0%"}}let v=new class{constructor(){this.name="prompt",this.inited=!1,this.prompt=new Terminal,this.locked=!1;let e=this.$={};e.section=new s(s.get("section#prompt")),e.promptXterm=new s("div",{className:"xterm"}),e.stopProgramButton=new s("button",{innerText:Msg.StopExecution,className:"master",title:"(Ctrl+Shift+S)"}).onclick(p,(()=>{p.dispatch(w,"rawPush",["",w.targetDevice,[],p.tabUID])})),e.quickActions=new s("div",{className:"quick-actions"}).append([new s("button",{innerText:Msg.ClearConsole}).onclick(this,(()=>{this.prompt.clear()})),new s("button",{innerText:Msg.ResetDevice,className:"master"}).onclick(p,(()=>{p.dispatch(w,"rawPush",["",w.targetDevice,[],p.tabUID])})),e.stopProgramButton,new s("button",{innerText:Msg.StopTimers,className:"master"}).onclick(p,(()=>{p.dispatch(w,"push",["from machine import Timer; [Timer(i).deinit() for i in range(0,16)]\r",w.targetDevice,[],p.tabUID])})),new s("button",{innerText:Msg.DeviceInfo,className:"master"}).onclick(p,(()=>{p.dispatch(w,"push",["import os; os.uname()\r",w.targetDevice,[],p.tabUID])}))]),e.container=new s("div",{className:"container"}).append([new s("div",{className:"wrapper"}).append(e.promptXterm),e.quickActions]),this.prompt.attachCustomKeyEventHandler((e=>{if(e.ctrlKey&&e.altKey&&"KeyC"===e.code&&"keydown"===e.type){const e=this.prompt.getSelection();if(e)return navigator.clipboard.writeText(e),!1}else if(e.ctrlKey&&e.altKey&&"KeyV"===e.code&&"keydown"===e.type)return navigator.clipboard.readText().then((e=>{p.dispatch(w,"push",[w.pasteMode(e),w.targetDevice,[],p.tabUID])})),!1;return!0})),this.prompt.open(e.promptXterm.$),this.prompt.setOption("fontSize",14),this.prompt.setOption("disableStdin",!0),this.prompt.onData((e=>{void 0!==w.current?w.rawPush(e,w.targetDevice):p.dispatch(w,"rawPush",[e,w.targetDevice])})),s.get("section#prompt").append(e.container.$),e.statusTasks=new s("div"),e.statusTasksButton=new s("button",{className:"status-icon",id:"tasks",title:Msg.TasksRunning}).append(e.statusTasks).onclick(this,(()=>{this.nav.click(),this.$.stopProgramButton.focus()})),new s(s.get("div#status-bar #globals")).append([e.statusTasksButton]),this.progress=new b,p.add(this,{write:this._write},!0),p.add(this,{ping:this._ping}),this.tabs={data:"",targetDevice:"",watcher:setInterval((()=>{""!=this.tabs.data&&(p.dispatch(this,"write",[this.tabs.data,w.targetDevice]),this.tabs.data="")}),25)},this.pingInterval=setInterval((()=>{void 0!==w.current&&p.dispatch(this,"ping",[{dirty:w.dirty,lock:w.lock,callback:w.callbacks.length},w.targetDevice])}),750)}init(){this.inited||(this.inited=!0)}deinit(){this.inited&&(this.inited=!1)}_ping(e,t){t===w.targetDevice&&(e.dirty||!e.lock&&e.callback>0?(this.$.statusTasksButton.classList.add("dirty"),this.$.statusTasks.innerText=Msg.StatusOngoingInput,this.locked=!0):e.lock&&e.callback>0?(this.$.statusTasksButton.classList.add("working"),1==e.callback?this.$.statusTasks.innerText=Msg.StatusWorkingOne:this.$.statusTasks.innerText=r.format([Msg.StatusWorking,e.callback]),this.locked=!0):(this.locked=!1,this.$.statusTasksButton.classList.remove("dirty"),this.$.statusTasksButton.classList.remove("working"),this.$.statusTasks.innerText=Msg.StatusReady))}on(){this.$.statusTasksButton.classList.add("on"),this.prompt.setOption("disableStdin",!1),this.prompt.focus()}off(){this.$.statusTasksButton.classList.remove("on"),this.prompt.setOption("disableStdin",!0),this.prompt.blur()}write(e){this.prompt.write(e),this.tabs.target!=w.targetDevice?(this.tabs.data=e,this.tabs.target=w.targetDevice):this.tabs.data+=e}_write(e,t){w.targetDevice==t&&this.prompt.write(e)}resize(){if(!this.inited)return;let e=(this.$.section.width-80)/7,t=this.$.section.height/17-64/14;this.prompt.resize(parseInt(e),parseInt(t))}setLoading(e,t){this.progress.load(e,t)}endLoading(){this.progress.end()}};class y{constructor(){let e=this.$={};e.container=new s("div",{id:"notify"}),document.querySelector("body").append(e.container.$),this.lastMessage=[],this.bufferCount=0,this.timeOut,this.timeOut2}}y.prototype.send=function(e){console.log(`Notify: ${e}`);let t=this.$.container.$;this.lastMessage==e?(this.bufferCount++,t.innerHTML=`(${this.bufferCount}x) ${e}`):(""==t.innerHTML?t.innerHTML=e:t.innerHTML=`${e}<hr>${t.innerHTML}`,this.bufferCount=0),t.classList.add("on"),this.lastMessage=e,window.clearTimeout(this.timeOut),this.timeOut=setTimeout((()=>{t.classList.remove("on"),this.bufferCount=0,this.lastMessage="",this.timeOut2=setTimeout((()=>{t.innerHTML=""}),150)}),4e3)};let $=new class{constructor(){this.name="notification",this.notify=new y,this.messages=[],this.inited=!1;let e=this.$={};e.header=new s("div",{className:"header"}).append([new s("h2",{innerText:Msg.PageNotification}),new s("button",{innerText:Msg.ClearAll,className:"icon text",id:"remove"}).onclick(this,this.clearAll)]),e.wrapper=new s("span",{className:"listy"}),e.splashHeader=new s("h2",{innerText:Msg.NewsAndAbout}),e.splash=new s("div",{id:"splash"}).append([new s("h3",{innerText:Msg.splash_welcome}),new s("div",{innerHTML:Msg.splash_message})]),e.container=new s("div",{className:"container"}).append([e.header,e.wrapper,e.splashHeader,e.splash]),e.section=new s(s.get("section#notification")).append(e.container.$),e.section.$.classList.add("default"),new s(s.get("div#status-bar #extra")).append([new s("button",{className:"status-icon",id:"forum",innerText:Msg.Forum,title:Msg.Forum}).onclick(this,(()=>{open("https://github.com/BIPES/BIPES/discussions","_blank").focus()}))]),p.add(this,{send:this._send,discard:this._discard,clearAll:this._clearAll})}send(e,t){let i=s.UID(),n=+new Date;p.dispatch(this,"send",[i,n,e,t]),this.inited||(console.log(u.fetch("notification")),console.log("boolean"==typeof u.fetch("notification")),console.log("boolean"),Array.isArray(u.fetch("notification"))&&(this.messages=JSON.parse(u.fetch("notification")),this._messagePush(i,n,e,t))),u.set("notification",JSON.stringify(this.messages)),this.inited||(this.messages=[])}_messagePush(e,t,s,i){this.messages.push({uid:e,timestamp:t,message:null==i?s:i})}_send(e,t,s,i){this.notify.send(s),this.nav.classList.add("new"),this.inited&&(this._messagePush(e,t,s,i),1==this.messages.length&&this.$.wrapper.removeChilds(),this.$.wrapper.$.insertBefore(this.$Card(this.messages[this.messages.length-1]).$,this.$.wrapper.$.firstChild))}init(){if(!this.inited){if(this.nav.classList.remove("new"),u.has("notification")&&"[]"!=u.fetch("notification")){this.messages=JSON.parse(u.fetch("notification"));let e=[];this.messages.forEach((t=>{e.unshift(this.$Card(t))})),this.$.wrapper.append(e)}else u.set("notification"),this._noNotification();this.inited=!0}}_noNotification(){this.$.wrapper.append(new s("span",{innerText:Msg.NoNotification}))}$Card(e){return new s("span",{uid:e.uid}).append([new s("div",{className:"row"}).append([new s("h4",{innerText:e.message})]),new s("div",{className:"row"}).append([new s("div",{innerText:new Date(e.timestamp).toLocaleString()})]),new s("button",{id:"discard",className:"icon notext"}).onclick(this,this.discard,[e.uid])])}deinit(){this.inited&&(this.$.wrapper.removeChilds(),this.messages=[],this.inited=!1)}discard(e,t){p.dispatch(this,"discard",[e]),u.set("notification",JSON.stringify(this.messages))}_discard(e){if(this.nav.classList.remove("new"),!this.inited)return;this.messages.forEach(((t,s)=>{t.uid==e&&this.messages.splice(s,1)}));let t=s.get(`[data-uid=${e}]`,this.$.wrapper.$);this.$.wrapper.$.removeChild(t),0==this.$.wrapper.$.childElementCount&&this._noNotification()}clearAll(){p.dispatch(this,"clearAll",[]),u.set("notification",JSON.stringify(this.messages))}_clearAll(){this.nav.classList.remove("new"),this.inited&&(this.messages=[],this.$.wrapper.removeChilds(),this._noNotification())}};class T{constructor(e,t){this.parent=e,this.projects=[],this.inited=!1,this.firstInited=!1;let i=this.$={};i.projects=new s("span",{className:"listy"}),i.fromHash=new s("div",{id:"ask-shared-project"}),i.fromHashListy=new s("span",{className:"listy"}),t.append([new s("div",{id:"shared-projects"}).append([new s("div",{className:"header"}).append([new s("h3",{innerText:Msg.SharedProjects})]),i.projects,new s("span",{className:"listy more-button"}).append([new s("button",{title:Msg.LoadMore}).append([new s("div",{className:"button icon"})]).onclick(this,this.fetchAutoFrom)])]),i.fromHash.append([new s("div",{className:"header"}).append([new s("h3",{innerText:Msg.ProjectFromURL}),new s("span",{innerText:Msg.ClickToImport})]),i.fromHashListy])]),window.location.hash&&(this.fromHash(window.location.hash.substring(1)),window.location.hash="")}init(){if(this.firstInited||(this.fetchSome({from:+new Date/1e3,limit:5}),this.firstInited=!0),this.inited)return;let e=[];this.projects.forEach((t=>e.unshift(this.$Card(t)))),this.$.projects.append(e),this.inited=!0}deinit(){this.inited&&(this.inited=!1)}async fetchSome(e,t){a.do("project/ls",e).then((e=>{let s=[];r.pushUnique(this.projects,e.projects,"uid").forEach((e=>s.unshift(this.$Card(e)))),this.$.projects.append(s),0==s.length&&!0===t&&$.send(`${Msg.PageProject}: ${Msg.NoOlderProjects}.`)})).catch((e=>{console.error(e)}))}async clone(e){a.do("project/o",{uid:e}).then((e=>{e.hasOwnProperty("projects")?this.parent.new(void 0,e.projects[0].data):$.send(`${Msg.PageProject}: ${Msg.SharedProjectDoesNotExist}.`)})).catch((e=>{console.error(e)}))}fetchAutoFrom(){let e=r.getMin(this.projects,"lastEdited");null!==e?this.fetchSome({from:e.lastEdited,limit:10},!0):this.fetchSome({from:+new Date/1e3,limit:10},!0)}$Card(e){return new s("button",{uid:e.uid}).append([new s("div",{className:"row"}).append([new s("h4",{id:"name",innerText:e.name}),new s("div",{id:"uid",innerText:e.uid})]),new s("div",{className:"row"}).append([new s("span",{id:"author",innerText:`${Msg.By} ${"a user"==e.author?Msg.AUser:e.author}`}),new s("div",{id:"lastEdited",innerText:r.prettyEditedAt(e.lastEdited)})])]).onclick(this,this.clone,[e.uid])}fromHash(e){a.do("project/o",{uid:e}).then((e=>{if(e.hasOwnProperty("projects")){let t=this.$Card(e.projects[0]);this.$.fromHashListy.append(t),this.$.fromHash.classList.add("on"),this.parent.nav.click(),t.focus()}else $.send(`${Msg.PageProject}: ${Msg.SharedProjectDoesNotExist}.`)})).catch((e=>{console.error(e)}))}}let D=new class{constructor(){this.name="project",this.currentUID=void 0,this.current=void 0,this.projects={},this.inited=!1,this.cors_token=u.has("cors_token")?u.fetch("cors_token"):u.set("cors_token",r.UID().substring(0,12)),this.username=u.has("username")?u.fetch("username"):u.set("username","a user");let e=this.$={};e.projects=new s("span",{className:"listy"}),e.username=new s("input",{value:"a user"==this.username?Msg.AUser:this.username}).onevent("change",this,this.nameChange),e.header=new s("div",{className:"header"}).append([new s("h2",{innerText:Msg.PageProject}),new s("span",{className:"username"}).append([new s("div",{innerText:Msg.HelloUser}),e.username,new s("div",{innerText:"!"})])]),e.wrapper=new s("span",{className:"projects"}).append([new s("div",{id:"user-projects"}).append([new s("div",{className:"header"}).append([new s("h3",{innerText:Msg.YourProjects}),new s("span").append([s.prototypeInputFile({id:"upload",className:"icon",innerText:Msg.Import}).onevent("change",this,this.upload),new s("button",{id:"add",className:"icon text",innerText:Msg.New}).onclick(this,this.new)])]),e.projects])]),e.container=new s("div",{className:"container"}).append([e.header,e.wrapper]),e.contextMenu=new s("div"),this.contextMenu=new n(e.contextMenu,this),e.section=new s(s.get("section#project")).append([e.container,e.contextMenu]),e.section.$.classList.add("default"),p.add(this,{new:this._new,remove:this._remove,update:this._update,lazyUpdate:this._lazyUpdate,nameChange:this._nameChange}),u.keys(/project-(.*)/).forEach((e=>{this.projects[e]=void 0})),d.isLocal||(this.shared=new T(this,e.wrapper))}_init(){if(0==Object.keys(this.projects).length)return void this.new();let e;e=u.has("current_project")?u.fetch("current_project"):Object.keys(this.projects)[0],this.select(e)}save(e){null==e&&(e=this.currentUID),this.projects[e].lastEdited=+new Date/1e3,this.write(e)}new(e,t){let s=r.UID(),i=null==t?this._emptyProject():t instanceof Object?t:JSON.parse(t);return u.set(`project-${s}`,JSON.stringify(i)),p.dispatch(this,"new",[s,i]),this.select(s),s}_new(e,t){this.projects[e]=void 0,this.inited&&this.$.projects.$.insertBefore(this.$Card(e).$,this.$.projects.$.firstChild)}remove(e){1==Object.keys(this.projects).length&&this.select(this.new());let t=this.projects[e].project.shared;t.hasOwnProperty("uid")&&""!==t.uid&&this.unshare(e,!0),p.dispatch(this,"remove",[e]),u.remove(`project-${e}`),this.contextMenu.close()}_remove(e){if(delete this.projects[e],!this.inited)return;let t=s.get(`[data-uid=${e}]`,this.$.projects.$);this.$.projects.$.removeChild(t),e==this.currentUID&&(this.currentUID=void 0,this.current=void 0,Object.keys(this.projects).length>0&&this.select(Object.keys(this.projects)[0]))}load(e){this.currentUID=e,this.current=this.projects[e];for(const t in bipes.page)"function"==typeof window.bipes.page[t].load&&this.projects.hasOwnProperty(e)&&"project"!=t&&(null==this.projects[e][t]&&(this.projects[e][t]=bipes.page[t].empty()),bipes.page[t].load(this.projects[e][t]));return e}unload(e){this.projects[e]=void 0,this.currentUID=void 0,this.current=void 0}set(e,t){null==t&&(t=this.currentUID);for(const s in e)this.projects[t][s]=e[s]}_emptyProject(){return{project:{name:Msg.EmptyProject,author:this.username,shared:{uid:"",token:""},createdAt:+new Date/1e3,lastEdited:+new Date/1e3}}}init(){if(this.inited)return;let e=[];for(const t in this.projects)e.unshift(this.$Card(t));if(this.$.projects.append(e),null!=this.currentUID){let e=s.get(`[data-uid=${this.currentUID}]`,this.$.projects.$);e.classList.add("on"),s.get("#name",e).disabled=!1}this.hasOwnProperty("shared")&&this.shared.init(),this.inited=!0}select(e){if(e==this.currentUID||!this.projects.hasOwnProperty(e))return;if(null!=this.currentUID){if(this.inited){let e=s.get(`[data-uid=${this.currentUID}]`,this.$.projects.$);e.classList.remove("on"),s.get("#name",e).disabled=!0}this.unload(e)}let t=u.fetch(`project-${e}`);if(this.projects[e]=JSON.parse(t),u.set("current_project",this.load(e)),this.inited){let e=s.get(`[data-uid=${this.currentUID}]`,this.$.projects.$);e.classList.add("on"),s.get("#name",e).disabled=!1}let i=u.fetch("username");i!=this.current.project.author&&(this.current.project.author=i)}deinit(){this.inited&&this.hasOwnProperty("shared")&&this.shared.deinit()}$Card(e){let t=JSON.parse(u.fetch(`project-${e}`)),i=""!=t.project.shared.uid?"shared":"";return new s("button",{className:i,uid:e}).append([new s("div",{className:"row"}).append([new s("h4",{id:"name",innerText:t.project.name}),new s("div",{id:"sharedUID",innerText:t.project.shared.uid})]),new s("div",{className:"row"}).append([new s("div",{id:"lastEdited",innerText:r.prettyEditedAt(t.project.lastEdited)})])]).onclick(this,this.select,[e]).onevent("contextmenu",this,(t=>{t.preventDefault();let s=[{id:"download",innerText:Msg.Download,fun:this.download,args:[e]}];if(e==this.currentUID){let t=this.projects[e];s.unshift({id:"rename",innerText:Msg.Rename,fun:this.rename,args:[e,t.project.name]},{id:"remove",innerText:Msg.Delete,fun:this.remove,args:[e]}),d.isLocal||(t.project.shared.hasOwnProperty("uid")&&""!==t.project.shared.uid?s.unshift({id:"share",innerText:Msg.UpdateShared,fun:this.updateShared,args:[e]},{id:"unshare",innerText:Msg.Unshare,fun:this.unshare,args:[e]}):s.unshift({id:"share",innerText:Msg.Share,fun:this.share,args:[e]}))}this.contextMenu.open(s,t)}))}write(e){e=null==e?this.currentUID:e,u.set(`project-${e}`,JSON.stringify(this.projects[e]))}rename(e,t){this.contextMenu.oninput({title:Msg.ProjectName,placeholder:t,value:t},((t,s)=>{s.preventDefault();let i=t.value;if(this.contextMenu.close(),null==i||""==i)return;let n={...this.projects[e].project};n.name=i;let r={name:n.name,shared:n.shared,lastEdited:n.lastEdited};p.dispatch(this,"lazyUpdate",[e,r]),this.update({project:n},e)}))}_lazyUpdate(e,t){s.lazyUpdate(this.$.projects.$,e,{name:t.name,lastEdited:r.prettyEditedAt(t.lastEdited),sharedUID:t.shared.uid});let i=s.get(`[data-uid='${e}']`,this.$.projects);""!=t.shared.uid?i.classList.add("shared"):i.classList.remove("shared")}update(e,t){t=null==t?this.currentUID:t,e.hasOwnProperty("project")||(e.project={...this.projects[t].project}),e.project.lastEdited=+new Date/1e3,p.dispatch(this,"update",[t,e,p.tabUID]),this.write(t)}_update(e,t,s){if(e===this.currentUID){for(const s in t)"load"!=s&&(this.projects[e][s]=t[s]);if(!t.hasOwnProperty("load")||0!=t.load)for(const i in t)if("project"===i);else for(const i in t)"function"==typeof window.bipes.page[i].load&&this.projects.hasOwnProperty(e)&&"project"!=i&&window.bipes.page[i].load(t[i],s)}}_mostRecent(){let e,t=0;for(const s in this.projects)this.projects[s].project.lastEdited>t&&(t=this.projects[s].project.lastEdited,e=s);return e}download(e){let t=u.fetch(`project-${e}`);t=t.replace(/("shared":{"uid":")(.*?)(","token":")(.*?)("})/g,"$1$3$5");let i=t.match(/{"project":{"name":"(.*?)"/)[1];s.prototypeDownload(`${i}.bipes.json`,t),this.contextMenu.close()}share(e){if(this.contextMenu.close(),!this.hasOwnProperty("shared"))return;let t=this.projects[e];a.do("project/cp",{cors_token:this.cors_token,data:t}).then((s=>{let i={...t.project};i.shared={uid:s.uid,token:s.token};let n={name:i.name,shared:i.shared,lastEdited:i.lastEdited};p.dispatch(this,"lazyUpdate",[e,n]),this.update({project:i},e),this.shared.$.projects.$.insertBefore(this.shared.$Card({uid:s.uid,name:i.name,author:"a user"==i.author?Msg.AUser:i.author,lastEdited:i.lastEdited}).$,this.shared.$.projects.$.firstChild)})).catch((e=>{console.error(e)}))}updateShared(e){this.contextMenu.close();let t=this.projects[e],s=t.project;this.hasOwnProperty("shared")&&a.do("project/w",{cors_token:this.cors_token,data:t}).then((t=>{if(t.uid!==s.shared.uid)return;let i={name:s.name,author:s.author,shared:s.shared,lastEdited:s.lastEdited};p.dispatch(this,"lazyUpdate",[e,i]),this.update({project:s},e)})).catch((e=>{console.error(e)}))}unshare(e){this.contextMenu.close();let t=this.projects[e],i=t.project;this.hasOwnProperty("shared")&&a.do("project/rm",{uid:i.shared.uid,token:i.shared.token,cors_token:this.cors_token}).then((n=>{if(n.uid!==i.shared.uid)return;try{let s={...t.project};s.shared={uid:"",token:""};let i={name:s.name,shared:s.shared,lastEdited:s.lastEdited};p.dispatch(this,"lazyUpdate",[e,i]),this.update({project:s},e)}catch(e){}let r=s.get(`[data-uid='${n.uid}']`,this.shared.$.projects);null!==r&&r.remove()})).catch((e=>{console.error(e)}))}upload(e){if(null==e.target.files[0])return;let t=e.target.files[0],s=new FileReader;s.onload=t=>{this.new(e,t.target.result)},s.readAsText(t)}nameChange(){null!=this.$.username.value&&""!=this.$.username.value||(this.$.username.value=Msg.AUser);let e=this.$.username.value==Msg.AUser?"a user":this.$.username.value;p.dispatch(this,"nameChange",[e,this.currentUID]),u.set("username",e);let t={...this.current.project};t.author=e,this.update({project:t},this.currentUID)}_nameChange(e){"a user"==e&&(e=Msg.AUser),this.$.username.value=e}},k={ESP8266:{nodename:"esp8266",name:"ESP8266",languages:["MicroPython","CircuitPython"],toolbox:"ESP32.xml",img:"Node-MCU-ESP.jpg",title:"<b>ESP8266</b><br>",boardID:"ESP module with ESP8266",description:"<BR><BR><input type='button' onclick='loadDoc();' value='Open Documentation' /> <BR><BR>To use ESP8266, simply connecto to MicroPython board using Wifi. Micropython must be previously installed.",pinout:[["D0 / GPIO16","16"],["D1 / GPIO05","5"],["D2 / GPIO04","4"],["D3 / GPIO00","0"],["D4 / LED / GPIO02","2"],["D5 / GPIO14","14"],["D6 / GPIO12","12"],["D7 / GPIO13","13"],["D8 / GPIO15","15"],["RX / GPIO03","3"],["TX / GPIO01","1"],["SD3 / GPIO10","10"],["SD2 / GPIO09","9"],["SD1 / GPIO08","8"],["CMD / GPIO11","11"],["SD0 / GPIO07","7"],["CLK / GPIO06","6"]]},ESP32C3:{nodename:"esp32C3",name:"ESP32C3",languages:["MicroPython","CircuitPython"],toolbox:"ESP32.xml",img:"ESP32C3_XIAO.png",title:"<b>XIAO ESP32C3</b><br>",description:"",pinout:[["D0 / A0 / GPIO2","2"],["D1 / A1 / GPIO03","3"],["D2 / A2 / GPIO4","4"],["D3 / A3 / GPIO5","5"],["D4 / SDA / GPIO6","6"],["D5 / SCL / GPIO7","7"],["D6 / TX / GPIO21","21"],["D7 / RX / GPIO20","20"],["D8 / SCK / GPIO8","8"],["D9 / MISO / GPIO9","9"],["D10 / MOSI / GPIO10","10"]]},ESP32:{nodename:"esp32",name:"ESP32",languages:["MicroPython","CircuitPython"],toolbox:"ESP32.xml",img:"ESP32.svg",title:"<b>ESP32</b><br>",description:"",pinout:[["D2 / CS / ADC2_2 / GPIO2","2"],["D4 / ADC2_0 / GPIO04","4"],["D12 / ADC2_5 / GPIO12","12"],["D13 / ADC2_4 / GPIO13","13"],["D14 / ADC2_6 / GPIO14","14"],["D15 / ADC2_3 / GPIO15","15"],["D18 / SCK / GPIO18","18"],["D19 / MISO / GPIO19","19"],["D21 / SDA / GPIO21","21"],["D22 / SCL / GPIO22 / RTS 0","22"],["D23 / MOSI / GPIO23","23"],["D25 / DAC 1 / ADC2_8 / GPIO25","25"],["D26 / DAC 2 / ADC2_9 / GPIO26","26"],["D27 / ADC2_7 / GPIO27","27"],["D32 / ADC1_4 / GPIO32","32"],["D33 / ADC1_5 / GPIO33","33"],["D34 / ADC1_6 / GPIO34","34"],["D35 / ADC1_7 / GPIO35","35"],["VP / ADC1_0 / GPIO36","36"],["VN / ADC1_3 / GPIO39","39"],["CS / GPIO05","5"],["TXD0 / GPIO01","1"],["RXD0 / GPIO03","3"],["RXD 1 / GPIO09","9"],["TXD 1 / GPIO10","10"],["RTS 1 / GPIO11","11"],["TXD2 / GPIO17","17"],["RXD2 / GPIO16","16"],["ADC2_1 / GPIO0","0"],["CTS2 / SPI_D / GPIO08","8"],["RTS2 / SPI_Q / GPIO07","7"],["CTS1 / SPI_CLK / GPIO06","6"]]},RPIPico:{nodename:"rpipico",name:"RPIPico",languages:["MicroPython","CircuitPython"],toolbox:"ESP32.xml",title:"<b>Raspberry Pi Pico</b><br>",boardID:"Raspberry Pi Pico with RP2040",img:"RPI_Pico.svg",description:"",pinout:[["LED / GPIO25","25"],["Pin 1 / GPIO0","0"],["Pin 2 / GPIO1","1"],["Pin 4 / GPIO2","4"],["Pin 5 / GPIO3","3"],["Pin 6 / GPIO4","4"],["Pin 7 / GPIO5","5"],["Pin 9 / GPIO6","6"],["Pin 10 / GPIO7","7"],["Pin 11 / GPIO8","8"],["Pin 12 / GPIO9","9"],["Pin 14 / GPIO10","10"],["Pin 15 / GPIO11","11"],["Pin 16 / GPIO12","12"],["Pin 17 / GPIO13","13"],["Pin 19 / GPIO14","14"],["Pin 20 / GPIO15","15"],["Pin 21 / GPIO16","16"],["Pin 22 / GPIO17","17"],["Pin 24 / GPIO18","18"],["Pin 25 / GPIO19","19"],["Pin 26 / GPIO20","20"],["Pin 27 / GPIO21","21"],["Pin 29 / GPIO22","22"],["Pin 26 / ADC0 / GPIO26","26"],["Pin 27 / ADC1 / GPIO27","27"],["Pin 28 / ADC2 / GPIO28","28"],["Internal Temp Sensor / ADC3","4"]]},WemosD1mini:{nodename:"wemosd1mini",name:"WemosD1mini",languages:["MicroPython","CircuitPython"],toolbox:"ESP32.xml",img:"Wemos-D1-Mini.png",title:"<b>ESP8266 - Wemos D1 Mini</b><br>",boardID:"ESP module with ESP8266",description:"<BR><BR><input type='button' onclick='loadDoc();' value='Open Documentation' /> <BR><BR>To use ESP8266, simply connecto to MicroPython board using Wifi. Micropython must be previously installed. Figure source: https://devonhubner.org/Using_MicroPython_with_a_WeMos_D1_Mini/",pinout:[["D0 / GPIO16","16"],["D5 / SCX / GPIO14","14"],["D6 / MISO / GPIO12","12"],["D7 / MOSI / GPIO13","13"],["D8 / SS / GPIO15","15"],["D4 / LED / GPIO02","2"],["D3 / GPIO00","0"],["D2 / SDA / GPIO04","4"],["D1 / SCL / GPIO05","5"],["RX / GPIO03","3"],["TX / GPIO01","1"]]},ESP32Oled:{nodename:"esp32",name:"ESP32oled",languages:["MicroPython","CircuitPython"],toolbox:"ESP32.xml",img:"esp32-oled.png",title:"<b>ESP32 board with OLED LCD and Battery</b><br>",boardID:"ESP32",description:"Yet another ESP32 board",pinout:[["SVP / GPIO36","36"],["SVN / GPIO39","39"],["P34 / GPIO24","34"],["P35 / GPIO35","35"],["P32 / GPIO32","32"],["P33 / GPIO33","33"],["P25 / GPIO25","25"],["P26 / GPIO26","26"],["P27 / GPIO27","27"],["P14 / GPIO14","14"],["P12 / GPIO12","12"],["P13 / GPIO13","13"],["SD2 / GPIO09","9"],["SD3 / GPIO10","10"],["CMD / GPIO11","11"],["SD0 / GPIO07","7"],["SD1 / GPIO08","8"],["P15 / GPIO15","15"],["P2 / GPIO02","2"],["P0 / GPIO00","0"],["P4 / OLED_SCL / GPIO04","4"],["P16 / GPIO16","16"],["P17 / GPIO17","17"],["P5 / OLED_SDA / GPIO05","5"],["P18 / VSPI_SCK / GPIO18","18"],["P19 / VSPI_MISO / GPIO19","19"],["P21 / GPIO21","21"],["RX / GPIO03","3"],["TX / GPIO01","1"],["P22 / GPIO22","22"],["P23 / VSPI_MOSI / GPIO23","23"]]},Arduino:{nodename:"arduino",name:"Arduino",languages:["Snek"],toolbox:"Arduino.xml",img:"Arduino.svg",title:"<b>Arduino UNO and Arduino MEGA. Image source: https://content.arduino.cc/assets/Pinout-UNOrev3_latest.png</b><br>",description:"",pinout:[["0 / RX","D0"],["1 / TX","D1"],["D2","D2"],["D3","D3"],["D4","D4"],["D5","D5"],["D6","D6"],["D7","D7"],["D8","D8"],["D9","D9"],["D10","D10"],["D11","D11"],["D12","D12"],["LED / D13","D13"],["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]]},ArduinoUno2:{nodename:"arduino",name:"ArduinoUno2",languages:["Snek"],toolbox:"Arduino.xml",img:"Arduino.svg",title:"<b>Arduino UNO and Arduino MEGA. Image source: https://content.arduino.cc/assets/Pinout-UNOrev3_latest.png</b><br>",description:"",pinout:[["0 / RX","D0"],["1 / TX","D1"],["D2","D2"],["D3","D3"],["D4","D4"],["D5","D5"],["D6","D6"],["D7","D7"],["D8","D8"],["D9","D9"],["D10","D10"],["D11","D11"],["D12","D12"],["LED / D13","D13"],["A0","A0"],["A1","A1"],["A2","A2"],["A3","A3"],["A4","A4"],["A5","A5"]]}};class x{constructor(e,t){this.mdTimestamp,this.config=u.has("WebSocketSetup")?u.fetch("WebSocketSetup",!0):u.set("WebSocketSetup",{address:"ws://192.168.0.35:8266",password:"",reconnect:!1},!0),this.parent=t;let i=this.$={};i.webSocketSetup=e,i.webSocketSetup.id="webSocketSetup",i.webSocketSetup.classList.add("popup"),i.webSocketSetup.onclick(this,this.close).onevent("contextmenu",this,this.close).onevent("mousedown",this,(e=>{this.mdTimestamp=+new Date})),i.title=new s("h3",{innerText:Msg.NewWebSocket}),i.urlLabel=new s("h4",{innerText:`${Msg.Address}:`}),i.urlInput=new s("input",{placeholder:`${Msg.DeviceAddress}, ${Msg.eg}. [ws/wss]://192.168.0.35:8266`,value:this.config.address}).onevent("change",this,(()=>{this.config.address=this.$.urlInput.value,u.set("WebSocketSetup",this.config,!0)})),i.passwordLabel=new s("h4",{innerText:`${Msg.Password}:`}),i.passwordInput=new s("input",{placeholder:Msg.DevicePassword,type:"password",value:this.config.password}).onevent("change",this,(()=>{this.config.password=this.$.passwordInput.value,u.set("WebSocketSetup",this.config,!0)})),i.buttonConnect=new s("button",{innerText:Msg.Connect,className:"icon text",id:"connect"}).onclick(this,(()=>{this.close(),t.connectWebSocket(this.config.address,this.config.password)})),i.buttonScan=new s("button",{innerText:Msg.ScanDevices,className:"icon text",id:"scan"}),i.info=new s("span",{className:"icon text warnings",innerText:Msg.WSWarning}),[i.reconnectInput,i.reconnectContainer]=s.prototypeCheckSwitch({id:"reconnectWebSocket",className:"reconnectWebSocket",innerText:Msg.ReconnectOnLost}),i.reconnectContainer.onevent("click",this,(e=>{e.preventDefault(),this.$.reconnectInput.$.checked=!this.$.reconnectInput.$.checked,this.config.reconnect=this.$.reconnectInput.$.checked,u.set("WebSocketSetup",this.config,!0)})),i.reconnectInput.$.checked=!0===this.config.reconnect,i.wrapper=new s("div").append([i.title,i.info]),this.webSocketScan=new P(this,i.wrapper),i.buttonScan.onclick(this,(()=>{s.switchState(this.webSocketScan.$.container.$),this.webSocketScan.$.inputPrefix.$.focus()})),i.wrapper.append([i.reconnectContainer,i.urlLabel,i.urlInput,i.passwordLabel,i.passwordInput,new s("div").append([i.buttonScan,i.buttonConnect])]),i.webSocketSetup.append(i.wrapper)}close(e){null!=e&&e.preventDefault(),null!=e&&"webSocketSetup"!=e.target.id||(+new Date-this.mdTimestamp<250||null==e)&&(this.$.wrapper.style.marginTop="110vh",i.off(this.$.webSocketSetup.$,void 0,125))}open(){let e=this.$;setTimeout((()=>{e.wrapper.style.marginTop=window.innerWidth/16>40?"10vh":`calc(${window.innerHeight}px - 21.5rem)`}),125),setTimeout((()=>{this.$.urlInput.$.focus()}),125),i.on(e.webSocketSetup.$,125)}}class P{constructor(e,t){this.parent=e,this.last=255,this.multiplier=0,this.count=0,this.found=0,this.scanning=!1,this.done=!1;let i=this.$={};i.label=new s("h4",{innerText:Msg.ScanPattern}),i.inputProtocol=new s("input",{value:"ws",placeholder:"xx"}),i.inputPrefix=new s("input",{value:"192.168.0",placeholder:"000.000.0"}),i.inputPort=new s("input",{value:"8266,8261",placeholder:"0000"}),i.buttonScan=new s("button",{innerText:Msg.StartScan,className:"noicon text",id:"scan"}).onclick(this,this.scan),i.container=new s("div",{id:"addressConf"}).append([i.label,new s("div").append([i.inputProtocol,new s("span",{innerText:"://"}),i.inputPrefix,new s("span",{innerText:".0/24:"}),i.inputPort]),i.buttonScan]),i.status=new s("div"),i.found=new s("div",{className:"listy"}),i.addressFound=new s("div",{id:"addressFound"}).append([i.status,i.found]),t.append([i.container,i.addressFound])}scan(){if(this.scanning)return;this.done=!1,this.$.container.$.classList.remove("on"),this.$.addressFound.$.classList.add("on");let e=this.$,t=e.inputProtocol.$.value.replaceAll(" ","").split(","),s=e.inputPrefix.$.value.replaceAll(" ","").split(","),i=e.inputPort.$.value.replaceAll(" ","").split(",");t.every(this._checkIPAddress)?(this.multiplier=t.length*s.length*i.length,this.scanning=!0,this.clear(),t.forEach((e=>{s.forEach((t=>{i.forEach((s=>{for(let i=1;i<=this.last;i++){let n=new WebSocket(`${e}://${t}.${i}:${s}`);n.start=performance.now,n.port=s,n.onerror=()=>{this.progress()},n.onopen=()=>{this.include(n.url),this.progress(),n.close()}}}))}))}))):$.send(`${Msg.PageDevice}: ${Msg.InvalidPrefix}.`)}progress(){this.done||(this.$.status.$.innerText=r.format([Msg.ScanningInfo,this.count,this.last*this.multiplier,this.found]),this.count+1==this.last*this.multiplier&&(this.$.status.$.innerText=r.format([Msg.DoneScanning,this.last*this.multiplier,this.found]),this.done=!0,this.scanning=!1,this.multiplier=0,this.count=0,this.found=0),this.count++)}include(e){this.found++,e=e.substring(0,e.length-1),this.$.found.append(new s("button",{className:"noicon text"}).append([new s("div",{innerText:e})]).onclick(this,this.apply,[e]))}apply(e){this.parent.$.urlInput.$.value=e,this.parent.$.passwordInput.$.focus()}clear(){this.$.found.removeChilds()}_checkIPAddress(e){return!/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(e)}}let S=new class{constructor(){this.name="device",this.pipe={},this.devices=u.has("device")&&"[]"!=u.fetch("device")?JSON.parse(u.fetch("device")):[],0===this.devices.length&&u.set("device"),this.inited=!1,this.deviceInfo=k,this.userDisconnectInput=!1;let e=this.$={},i=[];[9600,19200,38400,57600,115200].forEach((e=>{i.push(new s("option",{innerText:e,value:e}))})),e.baudRateDropdown=new s("select",{id:"baudrate"}).append(i),e.buttonWebSerial=new s("button",{id:"WebSerial"}).append([new s("span",{innerText:Msg.NotSupported}),new s("div",{innerText:"USB/Serial",className:"button icon"}),e.baudRateDropdown,new s("span",{className:"silk"}).onclick(this,this.connectWebSerial)]),s.setSelected(this.$.baudRateDropdown,115200),e.buttonWebSocket=new s("button",{id:"WebSocket"}).append([new s("span",{innerText:Msg.NotSupported}),new s("div",{innerText:"Wi-fi/Internet",className:"button icon"})]),e.buttonWebBluetooth=new s("button",{id:"WebBluetooth"}).append([new s("span",{innerText:Msg.NotSupported}),new s("div",{innerText:"Bluetooth",className:"button icon"})]).onclick(this,this.connectWebBluetooth),e.newConnection=new s("div",{id:"new-connection"}).append([new s("h3",{innerText:Msg.NewConnection}),new s("span",{className:"funky"}).append([e.buttonWebSerial,e.buttonWebSocket,e.buttonWebBluetooth])]),e.devices=new s("span",{className:"funky"}),e.h2=new s("h2",{innerText:Msg.PageDevice}),e.wrapper=new s("span",{className:"device-connect"}).append([new s("div",{id:"devices"}).append([new s("h3",{innerText:Msg.ConnectedDevices}),e.devices]),e.newConnection]);let n=[];for(const e in this.deviceInfo)n.push(new s("option",{innerText:this.deviceInfo[e].name,value:e}));e.targetDropdown=new s("select").append(n).onevent("change",this,this.setProjectTarget);let r=[];t.languages.forEach((e=>{r.push(new s("option",{innerText:e,value:e}))})),e.targetFirmwareDropdown=new s("select").append(r).onevent("change",this,this.setProjectTarget),e.pinout=new s("img",{id:"pinout"}),e.wrapper2=new s("span",{className:"device-current"}).append([new s("div",{id:"target-device"}).append([new s("div",{className:"header"}).append([new s("h3",{innerText:Msg.TargetDevice}),new s("div").append([e.targetDropdown,e.targetFirmwareDropdown])]),new s("div").append([new s("div").append([e.pinout]),new s("span",{innerText:Msg.ChangeTargetAnytime,className:"tips icon text"})])])]),e.container=new s("div",{className:"container"}).append([e.h2,e.wrapper,e.wrapper2]),e.section=new s(s.get("section#device")).append([e.container.$]),e.section.$.classList.add("default"),e.nav=new s(s.get("a#device")),e.webSocketSetup=new s("div"),this.webSocketSetup=new x(e.webSocketSetup,this),e.buttonWebSocket.onclick(this.webSocketSetup,this.webSocketSetup.open),e.section.append(e.webSocketSetup),e.statusDevice=new s("div"),e.statusDeviceButton=new s("button",{className:"status-icon",id:"target",title:Msg.TargetDevice}).append(e.statusDevice).onclick(this,(()=>{this.nav.click(),this.$.targetDropdown.focus()})),e.statusFirmware=new s("div"),e.statusFirmwareButton=new s("button",{className:"status-icon",id:"firmware",title:Msg.TargetFirmware}).append(e.statusFirmware).onclick(this,(()=>{this.nav.click(),this.$.targetFirmwareDropdown.focus()})),e.statusTarget=new s("div"),e.statusTarget.innerText=Msg.NotConnected,e.statusTargetButton=new s("button",{className:"status-icon",id:"device",title:Msg.ConnectedDevice}).append(e.statusTarget).onclick(this,(()=>{this.nav.click(),this.$.buttonWebSerial.focus()})),new s(s.get("div#status-bar #globals")).append([e.statusDeviceButton,e.statusFirmwareButton,e.statusTargetButton]),p.add(this,{use:this._use,unuse:this._unuse,updateInfo:this._updateInfo}),this.checkAPISupport()}connectPipes(){this.pipe=o({blocks:{deviceTarget:e=>{bipes.page.blocks.deviceTarget(e)}}})}empty(){return{firmware:t.language(""),target:"ESP32"}}load(e){e.firmware=t.language(e.firmware),e.target=Object.keys(this.deviceInfo).includes(e.target)?e.target:"ESP32",e.hasOwnProperty("target")&&bipes.page.blocks.toolbox(e.target),this.$.statusDevice.innerText=this.deviceInfo[e.target].name,this.$.statusFirmware.innerText=e.firmware,this.inited&&(e.hasOwnProperty("target")&&(s.setSelected(this.$.targetDropdown,e.target),this.$.pinout.$.src=`./static/page/device/media/${this.deviceInfo[e.target].img}`),e.hasOwnProperty("firmware")&&s.setSelected(this.$.targetFirmwareDropdown,e.firmware))}connectWebSerial(){null!=w.targetDevice&&this.select(w.targetDevice),w.connect("webserial",[this,this.use],this.$.baudRateDropdown.$.value)}connectWebSocket(e,t){null!=w.targetDevice&&this.select(w.targetDevice),w.connect("websocket",[this,this.use],{url:e,passwd:t})}connectWebBluetooth(){null!=w.targetDevice&&this.select(w.targetDevice),w.connect("webbluetooth",[this,this.use])}reconnect(e){this.userDisconnectInput||"WebSocket"==e&&this.webSocketSetup.config.reconnect&&setTimeout((()=>{this.connectWebSocket(this.webSocketSetup.config.address,this.webSocketSetup.config.password)}),1e3),this.userDisconnectInput=!1}use(){let e=+new Date;if(null==w.targetDevice)return void console.error("Device: Use function called without a established connection");let t={protocol:w.currentProtocol,nodename:Msg.Unknown,version:"-"};p.dispatch(this,"use",[w.targetDevice,e,t,p.tabUID]),this.$.nav.$.classList.add("using"),this.$.wrapper.$.classList.add("master");let i=s.get(`[data-uid=${w.targetDevice}]`,this.$.devices.$);null!==i&&i.classList.add("on"),this.$.statusTarget.innerText=`${t.nodename} ${t.version}`,this.$.statusTargetButton.classList.add("on"),this.inited||(this.devices=JSON.parse(u.fetch("device")),this._devicePush(w.targetDevice,e,t,p.tabUID)),u.set("device",JSON.stringify(this.devices)),setTimeout((()=>{this.fetchInfo(w.targetDevice)}),500)}_devicePush(e,t,s,i){this.devices.push({uid:e,timestamp:t,protocol:s.protocol,nodename:s.nodename,version:s.version,tab:i})}_use(e,t,s,i){this._devicePush(e,t,s,i),this.inited&&(1==this.devices.length&&this.$.devices.removeChilds(),this.$.devices.$.insertBefore(this.$Card(this.devices[this.devices.length-1]).$,this.$.devices.$.firstChild))}init(){if(this.inited)return;if(this.nav.classList.remove("new"),this.devices.length>0){let e=[];this.devices.forEach((t=>{e.unshift(this.$Card(t))})),this.$.devices.append(e)}else this._noDevice();if(null!=w.targetDevice){let e=s.get(`[data-uid=${w.targetDevice}]`,this.$.devices.$);null!==e&&e.classList.add("on")}this.inited=!0;let e=D.projects[D.currentUID];e.hasOwnProperty("device")&&this.load(e.device)}setProjectTarget(){let e=this.$.targetDropdown.$.value,t=this.$.targetFirmwareDropdown.$.value;e!=D.current.device.target&&this.pipe.blocks_deviceTarget(e),D.update({device:{target:e,firmware:t}}),this.$.statusDevice.innerText=this.deviceInfo[e].name,this.$.statusFirmware.innerText=t}_noDevice(){this.$.devices.append(new s("span",{innerText:Msg.NoConnectedLong}))}$Card(e){let t=e.tab==p.tabUID?Msg.OnThisTab:Msg.OnOtherTab,i=Msg.UsingThisDevice;return new s("button",{uid:e.uid}).append([new s("div").append([new s("div",{className:"silk"}).onclick(this,this.select,[e.uid]),new s("h4",{id:"nodename",innerText:e.nodename}),new s("div",{id:"version",innerText:`${e.version}`}),new s("div",{innerText:t}),new s("div",{className:"using-text",innerText:i}),new s("button",{id:"fetch",className:"icon text",innerText:Msg.GetInfo}).onclick(this,this.fetchInfo,[e.uid]),new s("button",{id:"disconnect",className:"icon text",innerText:Msg.Disconnect}).onclick(this,(()=>{this.userDisconnectInput=!0,w.disconnect()}),[])])])}deinit(){this.inited&&(this.$.devices.removeChilds(),this.inited=!1)}select(e,t){if(void 0!==t&&t.preventDefault(),null!=w.current)return;let i=()=>{this.$.nav.$.classList.remove("using");let e=s.get(`[data-uid=${w.targetDevice}]`,this.$.devices.$);null!=e&&e.classList.remove("on"),w.targetDevice=void 0,w.currentProtocol=void 0,this._statusNotConnected()};if(e!=w.targetDevice){null!=w.targetDevice&&i(),w.targetDevice=e,this.devices.forEach((t=>{t.uid==e&&(w.currentProtocol=t.protocol,this.$.statusTarget.innerText=`${t.nodename} ${t.version}`,this.$.statusTargetButton.classList.add("on"),v.on())})),this.$.nav.$.classList.add("using");let t=s.get(`[data-uid=${w.targetDevice}]`,this.$.devices.$);null!=t&&t.classList.add("on")}else i()}fetchInfo(e){let s=t.uname.cmd();w.push(s,w.targetDevice,["device","_fetchedInfo"])}_fetchedInfo(e,s,i){let n=t.uname.reg,r=t.uname.reg_str;if(!n.test(s)||!r.test(e))return;let a=e.match(r);p.dispatch(this,"updateInfo",[w.targetDevice,a[1],a[2]],p.tabUID),u.set("device",JSON.stringify(this.devices))}_updateInfo(e,t,i){this.devices.forEach((s=>{s.uid===e&&(s.nodename=t,s.version=i,w.targetDevice===e&&(this.$.statusTarget.innerText=`${s.nodename} ${s.version}`))})),this.inited&&(s.get(`[data-uid=${e}] #nodename`,this.$.devices.$).innerText=t,s.get(`[data-uid=${e}] #version`,this.$.devices.$).innerText=i)}unuse(e){this.devices.forEach(((t,s)=>{t.uid==e&&this.devices.splice(s,1)})),u.set("device",JSON.stringify(this.devices)),this.$.wrapper.$.classList.remove("master"),this._statusNotConnected(),p.dispatch(this,"unuse",[e])}_unuse(e){if(w.targetDevice==e&&(this.$.nav.$.classList.remove("using"),this._statusNotConnected(),w.targetDevice=void 0),this.devices.forEach(((t,s)=>{t.uid==e&&this.devices.splice(s,1)})),!this.inited)return;let t=s.get(`[data-uid=${e}]`,this.$.devices.$);null!==t&&(this.$.devices.$.removeChild(t),0==this.$.devices.$.childElementCount&&this._noDevice())}_statusNotConnected(){this.$.statusTarget.innerText=Msg.NotConnected,this.$.statusTargetButton.classList.remove("on"),v.off()}unresponsive(e){this.devices.forEach(((t,s)=>{t.uid==e&&$.send(r.format([Msg.DeviceUnresponsive,t.nodename,t.version]))}))}checkAPISupport(){"http:"==window.location.protocol&&"127.0.0.1"!=window.location.hostname&&(this.$.buttonWebSerial.$.classList.add("unsupported"),this.$.buttonWebBluetooth.$.classList.add("unsupported")),null==navigator.serial&&this.$.buttonWebSerial.$.classList.add("unsupported"),null==navigator.bluetooth&&this.$.buttonWebBluetooth.$.classList.add("unsupported")}};class M{constructor(e){this.parent=e,this.dom={},this.name="device",this.fileOnTarget=[{name:"",files:[]}],this.arrayBufferFile=new Uint8Array(0),this.arrayBufferFilename,this.arrayBufferTarget,this.arrayBufferPos;let t=this.$={};t.contextMenu=new s("div"),this.contextMenu=new n(t.contextMenu,this),this.parent.$.section.append(t.contextMenu),t.fileOnTarget=new s("span"),t.detailsFileOnTarget=s.prototypeDetails({id:"fileOnTarget",innerText:Msg.DeviceFiles,onevent:[{event:"click",self:this,fun:this.listDir,args:["/",void 0]},{event:"contextmenu",fun:(e,t,s)=>{s.preventDefault(),this.contextMenu.open([{id:"add",innerText:Msg.NewFolder,fun:this.newFolder,args:[e]},{id:"script",innerText:Msg.NewFile,fun:this.newScript,args:[e]},{id:"upload",accept:".py,.csv,.md",innerText:Msg.UploadFile,fun:this.uploadFile,args:[e]}],s)},args:["/"]}]}).append(t.fileOnTarget),t.saveToTarget=new s("button",{id:"upload",className:"icon text",innerText:Msg.Write,title:Msg.WriteToDevice}).onclick(this,this._fromEditor),this.parent.$.sidebar.append(t.detailsFileOnTarget),this.parent.$.header.append(t.saveToTarget),p.add([this.parent,this],{buildFileTree:this._buildFileTree,editorSetValue:this._editorSetValue,downloadValue:this._downloadValue,getFileArrayBuffer:this._getFileArrayBuffer,gotFileArrayBuffer:this.__gotFileArrayBuffer,putFileArrayBuffer:this._putFileArrayBuffer,putFileArrayBufferEnd:this.__putFileArrayBufferEnd})}listDir(e,s,i,n){if(null!=i){if(n.preventDefault(),"fileOnTarget"!=i.id&&i.open)return void(i.open=!1);if(i.open)return}e=null==e?"/":e,console.log("path: "+e);let r=t.ls.cmd(e);console.log("cmd1: "+r),p.dispatch(w,"push",[r,w.targetDevice,["files","device","_fetchRecursive"],null==s?p.tabUID:s])}_fetchRecursive(e,s,i){let n=t.ls.reg;if(!n.test(s))return console.error("Files: Incorrect command structure on _FetchRecursive"),!0;(s=s.match(n)[1]).startsWith("/")&&s.length>1&&(s=s.substring(1)),console.log("cmd: "+s);let r="/"==s?[""]:s.split("/"),a=this.fileOnTarget,o=new Array(r.length).fill(!1);if(a.every((e=>{console.log("\t p: "+e+" "+Object.getOwnPropertyNames(e)),console.log("\t p.name: "+e.name),console.log("\t p.files: "+e.files)})),console.log("map: "+r),console.log("ref: "+a),console.log("found: "+o),r.forEach(((e,t)=>{a.every((s=>(console.log("p.name: "+s.name),console.log("p.files: "+s.files),s.name!=e||(o[t]=!0,a=s.files,!1))))})),o.includes(!1))return console.error(`${Msg.PageFiles}: ${Msg.DirectoriesNotExistMapped}`),!0;a.length=0;let c=e.match(/(['])(?:(?=(\\?))\2.)*?\1/g);null!=c?(c=c.map((e=>e.replaceAll("'",""))),c.forEach((e=>{null==e.match(/\./)?a.push({name:e,files:[]}):a.push({name:e})}))):a.push({empty:!0}),p.dispatch([this.parent,this],"buildFileTree",[this.fileOnTarget,r,i])}_buildFileTree(e,t,i){if(this.fileOnTarget=e,i!=p.tabUID)return;let n=(e,t,i)=>{let r=[];e.forEach((e=>{if(null!=e.files)i.push(e.name),r.push(s.prototypeDetails({id:`path_${i.join("_")}`,innerText:e.name,onevent:[{event:"click",self:this,fun:this.listDir,args:[`/${i.join("/")}`,void 0]},{event:"contextmenu",fun:(e,t,s)=>{s.preventDefault(),this.contextMenu.open([{id:"add",innerText:Msg.NewFolder,fun:this.newFolder,args:[e]},{id:"script",innerText:Msg.NewFile,fun:this.newScript,args:[e]},{id:"upload",innerText:Msg.UploadFile,fun:this.uploadFile,args:[e]},{id:"remove",innerText:Msg.RemoveFolder,fun:this.remove,args:[e]}],s)},args:[`/${i.join("/")}`]}]})),e.files.length>0&&(r[r.length-1].$.open=!0,e.files[0].hasOwnProperty("empty")?(r[r.length-1].$.open=!0,r[r.length-1].append(new s("span",{innerText:"(Empty)",className:"emptyDir"}))):n(e.files,r[r.length-1],i)),i.pop();else{let t=0==i.length?"":`/${i.join("/")}`;r.push(e.dom=new s("button",{innerText:e.name,className:"listedFile"}).onclick(this,(()=>{this.fetchFile("editor",`${t}/${e.name}`)})).onevent("contextmenu",this,(s=>{s.preventDefault(),this.contextMenu.open([{id:"run",innerText:Msg.ExecuteScript,fun:this.runOnTarget,args:[`${t}/${e.name}`]},{id:"download",innerText:Msg.Download,fun:this.download,args:[`${t}/${e.name}`]},{id:"remove",innerText:Msg.Remove,fun:this.remove,args:[`${t}/${e.name}`]}],s)})))}})),t.append(r)};this.$.fileOnTarget.removeChilds(),n(this.fileOnTarget[0].files,this.$.fileOnTarget,[]),this.$.detailsFileOnTarget.$.open=!0}fetchFile(e,s){switch(w.currentProtocol){case"WebSocket":p.dispatch([this.parent,this],"getFileArrayBuffer",[s,e,p.tabUID,w.targetDevice]);break;case"WebSerial":case"WebBluetooth":let i=t.preopen.cmd(s),n=w.pasteMode(t.open.cmd(s));p.dispatch(w,"push",[i,w.targetDevice,[]]),p.dispatch(w,"push",[n,w.targetDevice,["files","device","editor"==e?"_fetchFileToEditor":"_fetchFileToDownload"],p.tabUID])}}_getFileArrayBuffer(e,t,s,i){if(null==w.current||w.targetDevice!=i)return;if(0!==this.arrayBufferFile.length)return void console.error("Files: another hexastream is running");let n=new Uint8Array(82);n[0]="W".charCodeAt(0),n[1]="A".charCodeAt(0),n[2]=2,n[16]=255&e.length,n[17]=e.length>>8&255;for(let t=0;t<e.length&&t<64;t++)n[18+t]=e.charCodeAt(t);p.dispatch(w,"push",[n,w.targetDevice,["files","device","__checkHexaGet"],s]),this.arrayBufferTarget="editor"==t?"editor":"download",this.arrayBufferFilename=e}__checkHexaGet(e,t,s){if(e[0]==t[0]&&e[1]==t[1]+1){this.arrayBufferFile=new Uint8Array(0),console.log("Files: Got get match");let e=new Uint8Array([0]);p.dispatch(w,"push",[e,w.targetDevice,["files","device","__checkFileGet"],s])}}__checkFileGet(e,t,s){if(3==t[0]){console.log("Files: Got file!");let e=(new TextDecoder).decode(this.arrayBufferFile),t=this.arrayBufferFilename,i=this.arrayBufferTarget;p.dispatch([this.parent,this],"gotFileArrayBuffer",[t,e,i,s]),this.arrayBufferTarget=void 0,this.arrayBufferFilename=void 0,this.arrayBufferFile=new Uint8Array(0)}else{let t=new Uint8Array(e.length-2+this.arrayBufferFile.length);t.set(this.arrayBufferFile),t.set(e.slice(2),this.arrayBufferFile.length),this.arrayBufferFile=t;let i=new Uint8Array([0]);p.dispatch(w,"push",[i,w.targetDevice,["files","device","__checkFileGet"],s])}}__gotFileArrayBuffer(e,t,s,i){p.tabUID==i&&("editor"==s?this._editorSetValue(e,t,i):"download"==s&&this._downloadValue(e,t,i))}_fetchFileToEditor(e,t,s){this._fetchFile("editor",e,t,s)}_fetchFileToDownload(e,t,s){this._fetchFile("download",e,t,s)}_fetchFile(e,s,i,n){let r=i.match(t.open.reg);if(null==r)return void console.error("Files: Could not fetch requested filename");r=r[1];let a=s.substring(2);"editor"==e?p.dispatch([this.parent,this],"editorSetValue",[r,a,n]):"download"==e&&p.dispatch([this.parent,this],"downloadValue",[r,a,n])}_editorSetValue(e,t,s){p.tabUID==s&&(this.parent.$.filename.$.value=e,this.parent.codemirror.dispatch({changes:{from:0,to:this.parent.codemirror.state.doc.length,insert:t}}),document.title=`${e} - BIPES`)}_downloadValue=(e,t,i)=>{p.tabUID==i&&s.prototypeDownload(e.substring(1),t)};_fromEditor(){let e=this.parent.codemirror.state.doc.toString(),t=this.parent.$.filename.$.value;this.writeToTarget(t,e)}writeToTarget(e,s){switch($.send(`${Msg.PageFiles}: ${r.format([Msg.WritingFile,e])}`),w.currentProtocol){case"WebSocket":p.dispatch([this.parent,this],"putFileArrayBuffer",[e,s,p.tabUID,w.targetDevice]);break;case"WebSerial":case"WebBluetooth":s instanceof ArrayBuffer&&(s=(new TextDecoder).decode(s)),s=s.replaceAll(/\\/g,"\\\\").replaceAll(/(\r\n|\r|\n)/g,"\\r").replaceAll(/'/g,"\\'").replaceAll(/"/g,'\\"');let i=w.pasteMode(t.write.cmd(e,s));p.dispatch(w,"push",[i,w.targetDevice,["files","device","_wroteToTarget"],p.tabUID])}}_putFileArrayBuffer(e,t,s,i){if(null==w.current||w.targetDevice!=i)return;if(0!==this.arrayBufferFile.length)return void console.error("Files: another hexastream is running");let n=t.length,r=new Uint8Array(82);r[0]="W".charCodeAt(0),r[1]="A".charCodeAt(0),r[2]=1,r[12]=255&n,r[13]=n>>8&255,r[14]=n>>16&255,r[15]=n>>24&255,r[16]=255&e.length,r[17]=e.length>>8&255;for(let t=0;t<e.length&&t<64;t++)r[18+t]=e.charCodeAt(t);this.arrayBufferFilename=e,this.arrayBufferFile=(new TextEncoder).encode(t),p.dispatch(w,"push",[r,w.targetDevice,["files","device","__checkHexaPut"],s])}__checkHexaPut(e,t,s){if(e[0]==t[0]&&e[1]==t[1]+1){console.log("Files: Got put match");let e=this.arrayBufferFile;p.dispatch(w,"push",[e,w.targetDevice,["files","device","__checkFilePut"],s])}}__checkFilePut(e,t,s){console.log("Files: file put finished"),p.dispatch([this.parent,this],"putFileArrayBufferEnd",[this.arrayBufferFilename,s]),this.arrayBufferFile=new Uint8Array(0),this.arrayBufferPos=void 0,this.arrayBufferFilename=void 0}__putFileArrayBufferEnd(e,t){p.tabUID==t&&this.listDir(e.match(/(.*)\/(?:.*)/)[1],t)}_wroteToTarget(e,s,i){let n=t.write.reg;n.test(s)&&this.listDir(s.match(n)[1],i)}newScript(e){this.contextMenu.oninput({title:Msg.NewFilename,placeholder:`${Msg.eg}: ${Msg.my_script}.py`},((t,s)=>{s.preventDefault();let i=t.value,n=`${r.format([Msg.CreateScriptHere,i])}`;this.contextMenu.close(),null!=i&&""!=i&&(-1==i.indexOf(".")&&(i+=".py"),this.writeToTarget(`${e}/${i}`,n))}))}remove(e){this.contextMenu.close();let s=t.rm.cmd(e);p.dispatch(w,"push",[s,w.targetDevice,["files","device","_removedFromTarget"],p.tabUID])}_removedFromTarget(e,s,i){let n=t.rm.reg;if(!n.test(s))return;let a=t.error.reg,o=s.match(n);if(a.test(e)){if("39"===e.match(a)[1])$.send(`${Msg.PageFiles}: ${r.format([Msg.FolderNotEmpty,o[1],o[2]])}`);else $.send(`${Msg.PageFiles}: ${r.format([Msg.CouldNotRemoveFolder,o[1],o[2]])}`)}this.listDir(o[1],i)}runOnTarget(e){this.contextMenu.close();let s=t.exec.cmd(e);p.dispatch(w,"push",[s,w.targetDevice,["files","device","_ranOnTarget"],p.tabUID])}_ranOnTarget(e,t,s){$.send(`${Msg.PageFiles}: ${Msg.ScriptFinishedExecuting}`)}download(e){this.contextMenu.close(),this.fetchFile("download",e)}newFolder(e){this.contextMenu.oninput({title:Msg.NewFolderName,placeholder:`${Msg.eg}: ${Msg.my_examples}`},((s,i)=>{i.preventDefault();let n=s.value.replaceAll(".","-");if(this.contextMenu.close(),null==n||""==n)return;let r=t.mkdir.cmd(e,n);p.dispatch(w,"push",[r,w.targetDevice,["files","device","_addedFolderOnTarget"],p.tabUID])}))}_addedFolderOnTarget(e,s,i){let n=t.mkdir.reg;n.test(s)&&this.listDir(s.match(n)[1],i)}uploadFile(e,t,s){if(null==t.files[0])return;let i=t.files[0],n=`${e}/${i.name}`,r=new FileReader;r.onload=e=>{this.writeToTarget(n,e.target.result)},r.readAsArrayBuffer(i),this.contextMenu.close()}}class _{constructor(e){this.name="project",this.parent=e,this.dom={},this.tree;let t=this.$={};t.contextMenu=new s("div"),this.contextMenu=new n(t.contextMenu,this),this.parent.$.section.append(t.contextMenu),t.section=new s(s.get("section#files")),t.detailsFileOnProject=s.prototypeDetails({id:"fileOnProject",innerText:Msg.ProjectFiles,onevent:[{event:"contextmenu",fun:(e,t,s)=>{s.preventDefault(),this.contextMenu.open([{id:"add",innerText:Msg.NewFolder,fun:this.newFolder,args:[e]},{id:"script",innerText:Msg.NewFile,fun:this.newScript,args:[e]},{id:"upload",accept:".py,.csv,.md",innerText:Msg.UploadFile,fun:this.uploadFile,args:[e]}],s)},args:["/"]}]}),t.saveToLocal=new s("button",{id:"save",className:"icon",title:Msg.SaveToProject}).onclick(this,this._fromEditor),this.parent.$.sidebar.append(t.detailsFileOnProject),this.parent.$.header.append(t.saveToLocal),p.add([this.parent,this],{newFolder:this._newFolder,newScript:this._newScript,remove:this._remove,save:this._save})}init(){if(void 0===this.tree){let e=D.projects[D.currentUID];e.hasOwnProperty("files")||(e.files={tree:{name:"",files:[]}}),this.tree=e.files.tree}this._buildFileTree([])}deinit(){this._destroyFileTree()}load(e){this.tree=e.tree,this.parent.inited&&(this._destroyFileTree(),this._buildFileTree([]))}_fromEditor(){let e=this.parent.codemirror.state.doc.toString(),t=this.parent.$.filename.$.value;p.dispatch([this.parent,this],"save",[t,e,D.currentUID,p.tabUID]),D.write()}_save(e,t,s,i){let n,a=e.split("/");if(a.shift(),null!=a&&""!=a)if(n=s===D.currentUID?this.objByName(a):this.objByName(a,s),!0!==n){if(!1===n){let e=a[a.length-1];return a.pop(),p.dispatch([this.parent,this],"newScript",["/"+a.join("/"),e,t,D.currentUID]),void D.write()}n.script=t}else i===p.tabUID&&$.send(`${Msg.PageFiles}: ${r.format([Msg.CreatePathFileBeforeSaving,e])}`)}newFolder(e){this.contextMenu.oninput({title:Msg.NewFolderName,placeholder:`${Msg.eg}: ${Msg.my_examples}`},((t,s)=>{s.preventDefault();let i=t.value.replaceAll(".","-");this.contextMenu.close(),null!=i&&""!=i&&(p.dispatch([this.parent,this],"newFolder",[e,i,D.currentUID]),D.write())}))}_newFolder(e,t,s){if(s!==D.currentUID)return;let i=this.objByName(e);if(!0===i||null==i.files)return;let n={name:t,files:[]};if(!i.files.every((e=>e.name!==t)))return void console.log(`${Msg.PageFiles}: ${r.format([Msg.FolderAlreadyExist,t,e])}"`);let a=(e+="/"==e?t:"/"+t).split("/");a.shift(),i.files.push(n),this.parent.inited&&s===D.currentUID&&(n.dom=this.$Span(n,a,!1),i.dom.$.append(n.dom.$),i.dom.$.open=!0)}remove(e){this.contextMenu.close(),p.dispatch([this.parent,this],"remove",[e,D.currentUID]),D.write()}_remove(e,t){if(t!==D.currentUID)return;let s=this.objByName(e);this.parent.inited&&s.dom.$.remove();let i=e.split("/"),n=i[i.length-1];i.shift(),i.pop(),s=this.objByName(i),!0!==s&&null!=s.files&&s.files.forEach(((e,t)=>{e.name==n&&s.files.splice(t,1)}))}newScript(e){this.contextMenu.oninput({title:Msg.NewFilename,placeholder:`${Msg.eg}: ${Msg.my_script}.py`},((t,s)=>{s.preventDefault();let i=t.value.replaceAll(" ","_");this.contextMenu.close(),null!=i&&""!=i&&(-1==i.indexOf(".")&&(i+=".py"),p.dispatch([this.parent,this],"newScript",[e,i,void 0,D.currentUID]),D.write())}))}_newScript(e,t,s,i){if(i!==D.currentUID)return;let n=this.objByName(e);if(!0===n||null==n.files)return;let a={name:t,script:null==s?`${r.format([Msg.CreateScriptHere,t])}`:s};if(!n.files.every((e=>e.name!==t)))return void $.send(`${Msg.PageFiles}: ${r.format([Msg.FileAlreadyExist,t,e])}`);let o=e.split("/");o.shift(),n.files.push(a),this.parent.inited&&(a.dom=this.$Span(a,o,!0),n.dom.$.append(a.dom.$),n.dom.$.open=!0)}uploadFile(e,t,s){if(null==t.files[0])return;let i=t.files[0];i.name;let n=new FileReader;n.onload=t=>{p.dispatch([this.parent,this],"newScript",[e,i.name,t.target.result,D.currentUID]),D.write()},n.readAsText(i),this.contextMenu.close()}download(e){this.contextMenu.close();let t=e.split("/");if(t.shift(),null==t||""==t)return;let i=this.objByName(t);!0!==i&&null!=i.script?s.prototypeDownload(e.substring(1),i.script):console.error(`${Msg.PageFiles}: ${Msg.FileNotExist}`)}execOnTarget(e){this.contextMenu.close();let t=e.split("/");if(t.shift(),null==t||""==t)return;let s=this.objByName(t);if(!0===s||null==s.script)return void console.error(`${Msg.PageFiles}: ${Msg.FileNotExist}`);let i=w.pasteMode(s.script);p.dispatch(w,"push",[i,w.targetDevice,["files","project","_execedOnTarget"],p.tabUID])}_execedOnTarget(e,t,s){$.send(`${Msg.PageFiles}: ${Msg.ScriptFinishedExecuting}`)}_buildFileTree(e){let t=(e,i,n)=>{let r=[];e.forEach((e=>{null!=e.files?(n.push(e.name),r.push(e.dom=this.$Span(e,n,!1)),e.files.length>0&&(r[r.length-1].$.open=!0,e.files[0].hasOwnProperty("empty")?(r[r.length-1].$.open=!0,r[r.length-1].append(new s("span",{innerText:`(${Msg.Empty})`,className:"emptyDir"}))):t(e.files,r[r.length-1],n)),n.pop()):(0!=n.length&&n.join("/"),r.push(e.dom=this.$Span(e,n,!0)))})),i.append(r)};t(this.tree.files,this.$.detailsFileOnProject,[]),this.tree.dom={},this.tree.dom.$=this.$.detailsFileOnProject.$,this.$.detailsFileOnProject.$.open=!0}_destroyFileTree(){let e=this.$.detailsFileOnProject.$,t=e.lastElementChild;for(;t;){if("SUMMARY"===t.nodeName)return;e.removeChild(t),t=e.lastElementChild}}$Span(e,t,i){switch(i){case!1:return s.prototypeDetails({id:`path_${t.join("_")}`,innerText:e.name,onevent:[{event:"contextmenu",fun:(e,t,s)=>{s.preventDefault(),this.contextMenu.open([{id:"add",innerText:Msg.NewFolder,fun:this.newFolder,args:[e]},{id:"script",innerText:Msg.NewFile,fun:this.newScript,args:[e]},{id:"upload",innerText:Msg.UploadFile,fun:this.uploadFile,args:[e]},{id:"remove",innerText:Msg.RemoveFolder,fun:this.remove,args:[e]}],s)},args:[`/${t.join("/")}`]}]});case!0:let i=`/${t.join("/")}`;return i+="/"==i?e.name:"/"+e.name,new s("button",{innerText:e.name,className:"listedFile"}).onclick(this,(()=>{this.open(i)})).onevent("contextmenu",this,(e=>{e.preventDefault(),this.contextMenu.open([{id:"run",innerText:Msg.ExecuteScript,fun:this.execOnTarget,args:[i]},{id:"download",innerText:Msg.Download,fun:this.download,args:[i]},{id:"remove",innerText:Msg.Remove,fun:this.remove,args:[i]}],e)}))}}open(e){let t=this.objByName(e);!0!==t&&(this.parent.$.filename.$.value=e,this.parent.codemirror.dispatch({changes:{from:0,to:this.parent.codemirror.state.doc.length,insert:t.script}}),document.title=`${e} - BIPES`)}objByName(e,t){let s,i;if(s=void 0===t?this.tree:D.projects[t].files.tree,"/"==e)return s;if("string"==typeof e)i=e.split("/"),i.shift();else if(e instanceof Array&&(i=e,0==e.length))return s;let n=s.files,r=s.files,a=new Array(i.length).fill(!1);if(i.forEach(((e,t)=>{n.every((s=>s.name!=e||(a[t]=!0,n=s.files,r=s,!1)))})),a.includes(!1)){let e=a.slice(0,a.length-1);return!(!e.includes(!1)||0==e.length)&&(console.error(`${Msg.PageFiles}: ${Msg.DirectoriesNotExistMapped}`),!0)}return r}}let I=new class{constructor(){this.name="files";let e=this.$={};e.section=new s(s.get("section#files")),e.sidebar=new s("div",{id:"sidebar"}),e.pane=new s("div",{id:"pane"}).append([new s("div",{className:"header",innerText:Msg.FileManager}),e.sidebar]),e.filename=new s("input",{id:"filename",autocomplete:"off",placeholder:Msg.Filename}).onchange(this,(()=>{let t=e.filename.$,s=t.value;s="/"!=s[0]&&s.length>1?"/"+s:s,s+=-1==s.indexOf(".")?".py":"",t.value=s,document.title=`${s} - BIPES`})),e.codemirror=new s("div",{id:"codemirror"}),e.header=new s("div",{id:"header"}).append([new s("button",{id:"hidePane",title:Msg.HideShowProjectTree}).onclick(this,(()=>{s.switchState(e.section.$,"hidePane")})),e.filename]),e.editor=new s("div",{id:"editor"}).append([e.header,e.codemirror]),e.container=new s("div",{className:"container"}).append([e.pane,e.editor]),e.section.append([e.container]),this.project=new _(this),this.device=new M(this),this.codemirror=CodeMirror(e.codemirror.$,r.fromUrl("theme"))}init(){this.inited||(this.project.init(),this.inited=!0)}deinit(){this.inited&&(this.project.deinit(),this.inited=!1)}load(e){e.hasOwnProperty("tree")&&this.project.load(e)}empty(){return{tree:{name:"",files:[{name:`${Msg.my_script}.py`,script:r.format([Msg.CreateScriptHere,`${Msg.my_script}.py`])}]}}}};const O="https://raw.githubusercontent.com/BIPES/examples-libraries/main/blocks-examples/",C={PID_water_boiler:{hostname:O,file:"pid_water_temp.xml"},PID_dc_motor:{hostname:O,file:"pid_dc_motor.xml"},PID_dc_motor_interrupt:{hostname:O,file:"pid_dc_motor_interrupt.xml"},PID_thermal_plant_ds1820:{hostname:O,file:"pid_thermal_plant_ds1820.xml"},TM1640:{hostname:O,file:"tm1640.xml"},songs:{hostname:O,file:"songs.xml"}},E={PID:{hostname:"https://raw.githubusercontent.com/gastmaier/micropython-simple-pid/master/simple_pid",file:"PID.py"},bme680:{hostname:"static/pylibs/BME680-Micropython",repo:"https://github.com/robert-hh/BME680-Micropython",file:"bme680.py"},sgp30:{hostname:"static/pylibs/micropython-sgp30",repo:"https://github.com/alexmrqt/micropython-sgp30",file:"adafruit_sgp30.py"},I2CLCD:{hostname:"static/pylibs/micropython-i2c-lcd/lib",file:["i2c_lcd.py","i2c_lcd_backlight.py","i2c_lcd_screen.py"]},ST7789:{hostname:"static/pylibs/st7789py_mpy",repo:"https://github.com/devbis/st7789py_mpy/blob/master/",file:"st7789py.py"},SSD1306:{hostname:"static/pylibs/micropython-adafruit-ssd1306/",repo:"https://raw.githubusercontent.com/adafruit/micropython-adafruit-ssd1306/master/",file:"ssd1306.py"},TM1640:{hostname:"https://raw.githubusercontent.com/mcauser/micropython-tm1640/master/",file:"tm1640.py"},HCSR04:{hostname:"https://raw.githubusercontent.com/rsc1975/micropython-hcsr04/master/",file:"hcsr04.py"},micropyGPS:{hostname:"static/pylibs/micropyGPS",repo:"https://raw.githubusercontent.com/rafaelaroca/mini_micropyGPS/master/esp32/",file:"micropyGPS.py"},BMP180:{hostname:"https://raw.githubusercontent.com/micropython-IMU/micropython-bmp180/master/",file:"bmp180.py"},CCS811:{hostname:"https://raw.githubusercontent.com/Notthemarsian/CCS811/master/",file:"CCS811.py"},MPU9250:{hostname:"https://bipes.net.br/ide/pylibs/",file:"mpu9250.py"},MPU6500:{hostname:"https://bipes.net.br/ide/pylibs/",file:"mpu6500.py"},AK8963:{hostname:"https://bipes.net.br/ide/pylibs/",file:"ak8963.py"},MFRC522:{hostname:"https://bipes.net.br/ide/pylibs/",file:"mfrc522.py"},ble_advertising:{hostname:"https://bipes.net.br/ide/pylibs/",file:"ble_advertising.py"},ble_uart_repl:{hostname:"https://bipes.net.br/ide/pylibs/",file:"ble_uart_repl.py"},ble_uart_peripheral:{hostname:"https://bipes.net.br/ide/pylibs/",file:"ble_uart_peripheral.py"},rtttl:{hostname:"https://bipes.net.br/ide/pylibs/",file:"rtttl.py"},songs:{hostname:"https://bipes.net.br/ide/pylibs/",file:"songs.py"},MCP23017:{hostname:"https://bipes.net.br/ide/pylibs/",file:"mcp23017.py"}},N="https://docs.google.com/document/d/e/2PACX-1vSk-9T56hP9K9EOhkF5SoNzsYl4TzDk-GEDnMssaFP_m-LEfI6IU-uRkkLP_HoONK0QmMrZVo_f27Fw",A={neopixel:{hostname:N,file:"pub"},TM1640:{hostname:N,file:"pub#h.iw35vui9vzi1"},sound:{hostname:N,file:"pub"},mpu6050:{hostname:N,file:"pub"},ds1820:{hostname:N,file:"pub#h.w84555jgod5j"},mfrc522:{hostname:N,file:"pub#h.owhbali4ayaj"},encoder:{hostname:N,file:"pub"},simple_pid:{hostname:"https://micropython-simple-pid.readthedocs.io",file:"en/latest/index.html"}};class L{constructor(e,t){this.generating=!1,this.parent=e,this.name="code",this.interval,this.executing;let i=this.$={};i.codeButton=new s("button",{title:`${Msg.ViewBlocksCode} (Ctrl+Shift+C)`,id:"code",className:"icon"}).onevent("click",this,this.show),i.runButton=new s("button",{title:`${Msg.RunBlocks} (Ctrl+Shift+R)`,className:"icon",id:"run"}).onevent("click",this,this.exec),i.editAsFileButton=new s("button",{innerText:Msg.BlocksEditAsFile,className:"icon text",id:"copy"}).onevent("click",this,this.copyEdit),i.codemirror=new s("div",{id:"codemirror"}).append([i.editAsFileButton]),i.container=new s("div",{id:"blocks-code"}).append([i.codemirror,i.codeButton,i.runButton]),t.append([i.container]),this.codemirror=CodeMirror(i.codemirror.$,r.fromUrl("theme"),{contenteditable:!1}),p.add([this.parent,this],{execedOnTarget:this._execedOnTarget})}init(){this.interval=setInterval((()=>{this.watcher()}),250),shortcut.add("Ctrl+Shift+C",(()=>{this.show()})),shortcut.add("Ctrl+Shift+R",(()=>{this.exec()})),shortcut.add("Ctrl+Shift+E",(()=>{if(this.exec(),""!==d.current[0]){let e=document.createEvent("HTMLEvents");e.initEvent("contextmenu",!0,!1),v.nav.dispatchEvent(e)}}))}deinit(){clearInterval(this.interval),shortcut.remove("Ctrl+Alt+C"),shortcut.remove("Ctrl+Shift+E"),shortcut.remove("Ctrl+Shift+R")}show(){this.generating=!this.generating,this.generating&&this.update(),s.switchState(this.$.container)}watcher(){v.locked?this.$.runButton.$.classList.add("on"):v.locked||this.$.runButton.$.classList.remove("on")}update(){if(!this.generating)return;let e=Blockly.Python.workspaceToCode(this.parent.workspace);this.codemirror.dispatch({changes:{from:0,to:this.codemirror.state.doc.length,insert:e}})}exec(){if(v.locked)return void p.dispatch(w,"rawPush",["",w.targetDevice,[],p.tabUID]);let e=Blockly.Python.workspaceToCode(this.parent.workspace),t=w.pasteMode(e);p.dispatch(w,"push",[t,w.targetDevice,["files","project","_execedOnTarget"],p.tabUID])}_execedOnTarget(e,t,s){this.$.runButton.$.classList.remove("on"),$.send(`${Msg.PageBlocks}:${Msg.ScriptFinishedExecuting}`)}copyEdit(){let e=Blockly.Python.workspaceToCode(this.parent.workspace);I.$.filename.$.value=`/${Msg.BlocksPy}`,I.codemirror.dispatch({changes:{from:0,to:I.codemirror.state.doc.length,insert:e}}),document.title=`${Msg.BlocksPy} - BIPES`,I.nav.click()}}Blockly.Themes.Dark=Blockly.Theme.defineTheme("dark",{base:Blockly.Themes.Classic,componentStyles:{workspaceBackgroundColour:"#1e1e1e",toolboxBackgroundColour:"blackBackground",toolboxForegroundColour:"#fff",flyoutBackgroundColour:"#252526",flyoutForegroundColour:"#ccc",flyoutOpacity:1,scrollbarColour:"#797979",insertionMarkerColour:"#fff",insertionMarkerOpacity:.3,scrollbarOpacity:.4,cursorColour:"#d0d0d0",blackBackground:"#333"}});let B={RGB2HEX:(e,t,s)=>"#"+componentToHex(e)+componentToHex(t)+componentToHex(s),HEX2RGB:e=>{e=e.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(e,t,s,i){return t+t+s+s+i+i}));let t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null},HUE2HEX:(e,t,s)=>{s/=100;const i=t*Math.min(s,1-s)/100,n=t=>{const n=(t+e/30)%12,r=s-i*Math.max(Math.min(n-3,9-n,1),-1);return Math.round(255*r).toString(16).padStart(2,"0")};return`#${n(0)}${n(8)}${n(4)}`}},j=(e,t)=>{if(!e.workspace.isDragging||e.workspace.isDragging())return;let s=[];t.forEach(((e,t)=>{e[0]()&&s.push(e[1])})),e.setWarningText(s.length>0?s.join("\n"):null)},F="is unknown, set at static/page/blocks/external.js",U=e=>{e.registerButtonCallback("installPyLib",(e=>{if(!/: (.*)$/.test(e.text_))return void console.error(`Blocks: Blockly button "${e.text_}" is invalid.`);let t=e.text_.match(/: (.*)$/)[1];if(!Object.keys(E).includes(t))return void console.error(`Blocks: Blockly "${t}" library ${F}.`);$.send(`${Msg.PageBlocks}: ${r.format([Msg.FetchingLib,t])}`);let s,i=E[t];console.log("lib: "+i),console.log("id: "+t),s="string"==typeof i.file?[i.file]:i.file,console.log("_toFetch: "+s),s.forEach((e=>{fetch(`${i.hostname}/${e}`,{method:"Get"}).then((e=>{if(!e.ok)throw new Error(e.status);return e.text()})).then((t=>{I.device.writeToTarget(`/lib/${e}`,t)}))}))})),e.registerButtonCallback("loadExample",(e=>{if(!/: (.*)$/.test(e.text_))return void console.error(`Blocks: Blockly button "${e.text_}" is invalid.`);let t=e.text_.match(/: (.*)$/)[1];if(!Object.keys(C).includes(t))return void console.error(`Blocks: Blockly "${t}" example ${F}.`);$.send(`${Msg.PageBlocks}: ${r.format([Msg.FetchingExample,t])}`);let s=C[t];"string"==typeof s.file&&fetch(`${s.hostname}/${s.file}`,{method:"Get"}).then((e=>{if(!e.ok)throw new Error(e.status);return e.text()})).then((e=>{Blockly.Events.disable(),Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(e),bipes.page.blocks.workspace),Blockly.Events.enable()}))})),e.registerButtonCallback("loadDoc",(e=>{if(!/: (.*)$/.test(e.text_))return void console.error(`Blocks: Blockly button "${e.text_}" is invalid.`);let t=e.text_.match(/: (.*)$/)[1];if(!Object.keys(A).includes(t))return void console.error(`Blocks: Blockly "${t}" documentation ${F}.`);let s=A[t];window.open(`${s.hostname}/${s.file}`,"_blank")}))},G={svgToPng_:function(e,t,s,i){var n=document.createElement("canvas"),r=n.getContext("2d"),a=new Image;n.width=10*t,n.height=10*s,a.onload=function(){r.drawImage(a,0,0,t,s,0,0,n.width,n.height);try{var e=n.toDataURL("image/png");i(e)}catch(e){console.warn("Error converting the workspace svg to a png"),i("")}},a.src=e},workspaceToSvg_:function(e,t,i,n){for(var r=document.getElementsByTagName("textarea"),a=0;a<r.length;a++)r[a].innerHTML=r[a].value;var o=e.getBlocksBoundingBox(),c=o.x||o.left,h=o.y||o.top,l=o.width||o.right-c,d=o.height||o.bottom-h,p=e.getCanvas().cloneNode(!0);p.removeAttribute("transform");var u=document.createElementNS("http://www.w3.org/2000/svg","svg");u.setAttribute("xmlns","http://www.w3.org/2000/svg"),u.appendChild(p),u.setAttribute("viewBox",c+" "+h+" "+l+" "+d),u.setAttribute("class","blocklySvg "+(e.options.renderer||"geras")+"-renderer "+(e.getTheme?e.getTheme().name+"-theme":"")),u.setAttribute("width",l),u.setAttribute("height",d),u.setAttribute("style","background-color: transparent");var g=[].slice.call(document.head.querySelectorAll("style")).filter((function(e){return/\.blocklySvg/.test(e.innerText)||0===e.id.indexOf("blockly-")})).map((function(e){return e.innerText})).join("\n"),m=document.createElement("style");m.innerHTML=g+"\n"+n,u.insertBefore(m,u.firstChild);var f=(new XMLSerializer).serializeToString(u);if(f=f.replace(/&nbsp/g,"&#160"),!0===i)s.prototypeDownload("workspace.bipes.svg",f);else{let e="data:image/svg+xml,"+encodeURIComponent(f);this.svgToPng_(e,l,d,(e=>{s.prototypeDownload("workspace.bipes.png",e)}))}},png:function(){this.workspaceToSvg_(bipes.page.blocks.workspace,(e=>{}))},svg:function(){this.workspaceToSvg_(bipes.page.blocks.workspace,(e=>{}),!0)}},R=new class{constructor(){this.name="blocks",this.timedResize,this.inited=!1,this.loadedWorkspace=!1,this.convertColor=B,this.warningIfTrue=j;let e=this.$={};e.section=new s(s.get("section#blocks")).append(new s("div",{id:"blockly"}));let t=Blockly.Xml.textToDom("<xml><category name='...'></category></xml>");this.workspace=Blockly.inject("blockly",{theme:"dark"===r.fromUrl("theme")?Blockly.Themes.Dark:Blockly.Themes.Light,toolbox:t,visible:!1,grid:{spacing:25,length:3,colour:"dark"===r.fromUrl("theme")?"#444":"#ccc",snap:!0},media:"./static/page/blocks/media/",oneBasedIndex:!1,zoom:{controls:!1,wheel:!0},move:{scrollbars:{horizontal:!0,vertical:!0},drag:!0,wheel:!1}}),Blockly.Python.INDENT="    ",U(this.workspace),this.export=G;for(const e in blockly_toolbox)blockly_toolbox[e]=blockly_toolbox[e].replace(/%{(\w+)}/g,((e,t)=>Blockly.Msg[t]));this.code=new L(this,e.section)}init(){if(this.inited)return;this.workspace.setVisible(!0),this.code.init(),this.inited=!0;let e=D.projects[D.currentUID];e.hasOwnProperty("blocks")&&this.load(e.blocks),e.hasOwnProperty("device")&&this.toolbox(e.device.target),this.workspace.addChangeListener(this.update),shortcut.add("Ctrl+Shift+L",(()=>{this.export.png()})),shortcut.add("Ctrl+Shift+Alt+L",(()=>{this.export.svg()}))}deinit(){this.inited&&(this.workspace.removeChangeListener(this.update),this.workspace.clear(),this.workspace.setVisible(!1),this.code.deinit(),this.inited=!1,shortcut.remove("Ctrl+Shift+L"),shortcut.remove("Ctrl+Shift+Alt+L"))}resize(){Blockly.svgResize(this.workspace),clearTimeout(this.timedResize),this.timedResize=setTimeout((()=>{Blockly.svgResize(this.workspace)}),250)}load(e,t){this.inited&&t!=p.tabUID&&e.hasOwnProperty("xml")&&(this.loadedWorkspace=!1,Blockly.Events.disable(),Blockly.Xml.clearWorkspaceAndLoadFromXml(Blockly.Xml.textToDom(e.xml),this.workspace),Blockly.Events.enable(),this.code.update())}update(e){if(!e.recordUndo)return;R.code.update();let t=Blockly.Xml.domToText(Blockly.Xml.workspaceToDom(R.workspace));D.update({blocks:{xml:t}})}toolbox(e){if(!this.inited)return;let t=S.deviceInfo[e].toolbox.replace(".xml","");this.workspace.updateToolbox(blockly_toolbox[t]),this.workspace.scrollCenter()}empty(){return{xml:'<xml xmlns="https://bipes.net.br/ide"></xml>'}}deviceTarget(e){let t=this.workspace.getBlocksByType("pinout");t.forEach((t=>{t.refresh(e)})),0!=t.length&&$.send(`${Msg.PageBlocks}: ${Msg.DeviceChangedCheckPins}`)}},W={session:u.has("mqtt_session")?u.fetch("mqtt_session"):u.set("mqtt_session",r.SID())};let V=new class{constructor(){this._data=[],this._keys=[],this._coorLength={},this.ref,this._inited=!1,this.topics={session:!1,fetching:!1},this.isConnected=!1,d.isLocal||this.do("public_conf").then((e=>{if(!1!==e.easyMQTT.password){for(const t in e.easyMQTT)W[t]=e.easyMQTT[t];this.client=new Paho.MQTT.Client(W.host,W.ws_port,"",`bipes${new Date}`),this.client.onConnectionLost=()=>{this.onConnectionLost()},this.client.onMessageArrived=e=>{this.onMessageArrived(e)},this.client.connect({useSSL:W.ssl,userName:"bipes",password:W.password,onSuccess:()=>{this.onConnect()}})}}))}init(e){this.ref=e,this._inited||d.isLocal||(this.do(`${W.session}/ls`).then((e=>{if(e.hasOwnProperty(W.session)){if(0===e[W.session].length)return void this.ref.regenCharts("EasyMQTT");this.topics.fetching=[],e[W.session].forEach((e=>{this.topics.fetching.push(e.topic),this.do(`${W.session}/${e.topic.replaceAll("/","$")}/grep`).then((t=>{t.hasOwnProperty(W.session)&&(this._data[e.topic]=[]),this._keys.push(e.topic),t[W.session].reverse().forEach((t=>{this.write(e.topic,t.data)})),this.topics.fetching.splice(this.topics.fetching.indexOf(e.topic),1),0===this.topics.fetching.length&&this.ref.regenCharts("EasyMQTT")}))}))}})),this._inited=!0)}deinit(){this.ref=void 0}reinit(){this._data=[],this._keys=[],this._coorLength={},this._inited=!1,this.topics.fetching=!1,this.unsubscribe(),this.subscribe(),this.init(this.ref)}async do(e){const t=await fetch(`${window.location.href.match("^(.*)/ide")[1]}/mqtt/${e}`,{method:"Post",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});if(!t.ok)throw new Error(t.status);return await t.json()}async write(e,t,s){let i=t.split(",").map((e=>parseFloat(e)));if(i.every((e=>!isNaN(e)))&&i.length>1)return void this.push(e,i,s,"chart");let n=parseFloat(t);isNaN(t)||this.push(e,n,s,"gauge")}push(e,t,s,i){"gauge"!=i||!0!==s?t instanceof Array&&(this._data.hasOwnProperty(e)||(this._keys.push(e),this._data[e]=[],this._coorLength[e]=0),this._data[e].push(t),void 0!==this.ref&&!0===s&&this.ref.chartsPush(e,this._data[e],t,"EasyMQTT")):this.ref.gaugesPush(e,t,"EasyMQTT")}remove(e){this._keys.forEach(((t,s)=>{t==e&&this._keys.splice(s,1)})),delete this._data[e]}chartData(e,t){let s;s=this._keys.includes(e)?this._data[e]:[];const i=s.map((e=>e.length)),n=Math.max(...i);this._coorLength[e]=n;let a=s.map((function(e){return e.slice()})),o=parseInt(t.setup.limitPoints);isNaN(o)||(a=a.slice(-o)),r.transpose(a);let c=t.setup.labels.split(",").map((e=>e.trim()));c=1==c.length&&""==c[0]?[]:c;let h=[];for(let e=1;e<a.length;e++){let t=e<7?r.colors(e-1):r.randomColor();h.push({label:e-1<c.length?c[e-1]:`Data ${e}`,data:a[e],backgroundColor:t[1],borderColor:t[0],borderWidth:1})}return{labels:a[0],datasets:h}}onConnect(){bipes.page.dashboard.storagemanager.onConnect(),this.isConnected=!0,this.subscribe()}onConnectionLost(){bipes.page.dashboard.storagemanager.onConnectionLost(),this.isConnected=!1,this.topics.subscribed=[]}onMessageArrived(e){let t=Array(...e.destinationName.split("/")),s=String(e.payloadString);t.shift(),this.write(t.join("/"),s,!0)}subscribe(){this.client.subscribe(`${W.session}/#`),this.topics.session=W.session}unsubscribe(){this.client.unsubscribe(`${this.topics.session}/#`),this.topics.session=!1}};let Q=new class{constructor(){this._data=[],this._keys=[],this._coorLength={},this.buffer="",this.ref}init(e){this.ref=e}deinit(){this.ref=void 0}write(e,t){this.buffer+=e;let s,i=/\r\n(?:>>> )?\$(.*):(.*)\r\n/;if(i.test(this.buffer)&&(s=this.buffer.match(i),3==s.length))if(!0===t)V.client.send(`${W.session}/${s[1]}`,s[2],0,!1);else{let e=s[2].split(",").map((e=>parseFloat(e)));if(e.every((e=>!isNaN(e)))&&e.length>1)this.push(s[1],e,"chart");else{let e=parseFloat(s[2]);isNaN(e)||this.push(s[1],e,"gauge")}}this.buffer=this.buffer.replace(i,"\r\n")}push(e,t,s){if("gauge"!=s||void 0===this.ref){if("Array"==t.constructor.name&&(this._keys.includes(e)||(this._keys.push(e),this._data[e]=[]),this._data[e].push(t),u.set(`datastorage:${e}`,JSON.stringify(this._data[e])),void 0!==this.ref)){let s=5==this._data[e].length;(parseInt(this._coorLength[e])<parseInt(t.length)||this._coorLength[e]===-1/0)&&(this._coorLength[e]=t.length,s=!0),this.ref.chartsPush(e,t,s,"Console")}}else this.ref.gaugesPush(e,t,"Console")}remove(e){this._keys.forEach(((t,s)=>{t==e&&this._keys.splice(s,1)})),delete this._data[e]}chartData(e,t){if(!this._keys.includes(e))if(this._keys.push(e),u.has(`datastorage:${e}`)){this._data[e]=JSON.parse(u.fetch(`datastorage:${e}`));const t=this._data[e].map((e=>e.length)),s=Math.max(...t);this._coorLength[e]=s}else this._data[e]=[],this._coorLength[e]=0,u.set(`datastorage:${e}`,JSON.stringify(this._data[e]));let s=this._data[e].map((function(e){return e.slice()})),i=parseInt(t.setup.limitPoints);isNaN(i)||(s=s.slice(-i)),r.transpose(s);let n=t.setup.labels.split(",").map((e=>e.trim()));n=1==n.length&&""==n[0]?[]:n;let a=[];for(let e=1;e<s.length;e++){let t=e<7?r.colors(e-1):r.randomColor();a.push({label:e-1<n.length?n[e-1]:`Data ${e}`,data:s[e],backgroundColor:t[1],borderColor:t[0],borderWidth:1})}return{labels:s[0],datasets:a}}};const z={types:["charts","switches","ranges","gauges"],init:()=>{"dark"===r.fromUrl("theme")?(Chart.defaults.color="#eee",Chart.defaults.borderColor="rgba(255,255,255,0.1)"):Chart.defaults.color="#222"},deinit:e=>{z.types.forEach((t=>{e[t].forEach((e=>{e.destroy()})),e[t]=[]}))},remove:(e,t)=>{switch(t.type){case"plugin":e.players.forEach(((s,i)=>{s.sid==t.sid&&((s.source="DASH")&&s.destroy(),e.players.splice(i,1))}));break;case"chart":e.charts.forEach(((s,i)=>{s.sid==t.sid&&(s.destroy(),e.charts.splice(i,1))}))}},include:(e,t,s)=>{switch("localStorage"==t.setup.source?t.setup.source="Console":"easyMQTT"==t.setup.source&&(t.setup.source="EasyMQTT"),t.type){case"chart":H.include(e,t,s);break;case"switch":q.include(e,t,s);break;case"range":J.include(e,t,s);break;case"gauge":K.include(e,t,s)}},regen:(e,t)=>{if("chart"===t.type)H.regen(e,t)}};class H{constructor(){}static chart(e,t){let s;switch(e.setup.source){case"Console":s=Q.chartData(e.setup.topic,e);break;case"EasyMQTT":if(!V._inited)return{sid:e.sid,topic:e.setup.topic,source:e.setup.source,destroy:()=>{}};s=V.chartData(e.setup.topic,e)}let i={maintainAspectRatio:!1,plugins:{legend:{position:"top"}},scales:{},animation:{duration:0},resizeDelay:125};""!=e.setup.title&&(i.plugins.title={display:!0,text:e.setup.title,font:{size:14}}),e.setup.timeseries&&(i.scales.xAxes={type:"time",distribution:"linear"}),""!=e.setup.xLabel&&(i.scales.x={display:!0,title:{display:!0,text:e.setup.xLabel}}),""!=e.setup.yLabel?i.scales.y={beginAtZero:!0,display:!0,title:{display:!0,text:e.setup.yLabel}}:i.scales.y={beginAtZero:!0};let n=new Chart(t.$,{type:e.setup.chartType,data:s,options:i});n.sid=e.sid,n.topic=e.setup.topic,n.source=e.setup.source;let r=parseInt(e.setup.limitPoints);return isNaN(r)||(n.limitPoints=r),n}static regen(e,t){for(const s in e)e[s].sid==t.sid&&(e[s].destroy(),e[s]=H.chart(t,t.target))}static include(e,t,i){t.target=new s("canvas",{className:"chart"});let n=new s("div").append([i.silk,i.grab,i.remove,t.target]),r=new s("div",{sid:t.sid,className:"chart broad"}).append(n);e.muuri.add(r.$),e.charts.push(H.chart(t,t.target)),i.silk.onevent("contextmenu",e,(t=>{t.preventDefault(),s.switchState(e.parent.$.dashboard)})),i.grab.onclick(e,e.edit,[t,r])}}class X{constructor(){}static stream(e,t){switch(data.setup.source){case"DASH":let s=dashjs.MediaPlayer().create();return s.sid=e,s.source="DASH",s.updateSettings({streaming:{lowLatencyEnabled:!0}}),s.initialize(t,data.setup.manifest,!0),X.dashApplyParamenters(s),s;case"MJPEG":let i={sid:e,source:"MJPEG",attachSource:e=>{t.src=e}};return i.attachSource(data.setup.manifest),i}}static regen(e,t,s,i){for(const t in e.players)e.players[t].sid==s&&("DASH"==e.players[t].source&&e.players[t].destroy(),e.players[t]=X.stream(s,i))}static manifest(e,t,s){for(const i in e.players)if(e.players[i].sid==s)switch(e.players[i].source){case"DASH":case"MJPEG":e.players[i].attachSource(t.manifest),e.players[i].sid=s}}static dashApplyParamenters(e){let t=parseFloat(10,10),s=parseFloat(.05,10),i=parseFloat(.05,10),n=parseFloat(60,10);e.updateSettings({streaming:{delay:{liveDelay:t},liveCatchup:{minDrift:s,playbackRate:i,latencyThreshold:n}}})}}class q{constructor(e,t){this.sid=e.sid,this.dom=t,this.target=e.setup.target,this.topic=e.setup.topic,this.messageOn=e.setup.messageOn,this.messageOff=e.setup.messageOff,this.state=!1}destroy(){this.target=void 0,this.topic="",this.messageOn="",this.messageOff="",this.state=!1,this.dom.removeChilds()}command(){"EasyMQTT"==this.target?(this.state?(V.client.send(`${W.session}/${this.topic}`,this.messageOff,0,!1),this.dom.$.classList.remove("on")):(V.client.send(`${W.session}/${this.topic}`,this.messageOn,0,!1),this.dom.$.classList.add("on")),this.state=!this.state):"Console"==this.target&&(this.state?(p.dispatch(w,"push",[`${this.topic}(${this.messageOff})\r`,w.targetDevice,[],p.tabUID]),this.dom.$.classList.remove("on")):(p.dispatch(w,"push",[`${this.topic}(${this.messageOn})\r`,w.targetDevice,[],p.tabUID]),this.dom.$.classList.add("on")),this.state=!this.state)}static switch(e,t){let i=new q(e,t),n=new s("h2",{innerText:e.setup.title}),r=new s("h3",{innerText:e.setup.subtitle});return t.onclick(i,i.command),t.append([n,r]),i}static regen(e,t){for(const s in e.switches)e.switches[s].sid==t.sid&&(e.switches[s].destroy(),e.switches[s]=q.switch(t,t.target))}static include(e,t,i){t.target=new s("button",{className:"press"});let n=new s("div").append([i.grab,i.remove,t.target]),r=new s("div",{sid:t.sid,className:"switch tiny"}).append(n);e.muuri.add(r.$),e.switches.push(q.switch(t,t.target)),t.target.onevent("contextmenu",e,(t=>{t.preventDefault(),s.switchState(e.parent.$.dashboard)})),i.grab.onclick(e,e.edit,[t,r])}}class J{constructor(e,t){this.sid=e.sid,this.dom=t,this.target=e.setup.target,this.topic=e.setup.topic,this.minValue=Number(e.setup.minValue),this.maxValue=Number(e.setup.maxValue),this.step=Number(e.setup.step),this.precision=String(e.setup.step).includes(".")?e.setup.step.split(".")[1].length:0}destroy(){this.target=void 0,this.topic="",this.minValue=void 0,this.maxValue=void 0,this.step=void 0,this.input=void 0,this.dom.removeChilds()}command(e){if(!["EasyMQTT","Console"].includes(this.target))return;let t=this.input.value;"lower"==e?t=Number(this.input.value)-this.step:"raise"==e?t=Number(this.input.value)+this.step:e instanceof HTMLInputElement&&(t=Number(this.input.value)),t=t<this.minValue?this.minValue:t,t=t>this.maxValue?this.maxValue:t,t=r.round(t,this.precision),this.input.value=t,"EasyMQTT"==this.target?V.client.send(`${W.session}/${this.topic}`,String(t),0,!1):"Console"==this.target&&p.dispatch(w,"push",[`${this.topic}(${t})\r`,w.targetDevice,[],p.tabUID])}static range(e,t){let i=new J(e,t),n=new s("h2",{innerText:e.setup.title}),r=new s("h3",{innerText:e.setup.subtitle});return i.input=new s("input"),i.input.value=(Number(e.setup.maxValue)+Number(e.setup.minValue))/2,i.input.onevent("change",i,i.command,[i.input.$]),t.append([n,new s("div",{className:"container"}).append([new s("button",{id:"lower",className:"icon"}).onclick(i,i.command,["lower"]),i.input,new s("button",{id:"raise",className:"icon"}).onclick(i,i.command,["raise"])]),r]),i}static regen(e,t){for(const s in e.ranges)e.ranges[s].sid==t.sid&&(e.ranges[s].destroy(),e.ranges[s]=J.range(t,t.target))}static include(e,t,i){t.target=new s("span");let n=new s("div").append([i.grab,i.remove,t.target]),r=new s("div",{sid:t.sid,className:"range wide"}).append(n);e.muuri.add(r.$),e.ranges.push(J.range(t,t.target)),t.target.onevent("contextmenu",e,(t=>{t.preventDefault(),s.switchState(e.parent.$.dashboard)})),i.grab.onclick(e,e.edit,[t,r])}}class K{constructor(e,t){this.sid=e.sid,this.dom=t,this.source=e.setup.source,this.topic=e.setup.topic,this.minValue=Number(e.setup.minValue),this.maxValue=Number(e.setup.maxValue)}destroy(){this.source=void 0,this.topic="",this.minValue=void 0,this.maxValue=void 0,this.input=void 0,this.dom.removeChilds()}static gauge(e,t){let i=new K(e,t),n=new s("h2",{innerText:e.setup.title}),r=new s("h3",{innerText:e.setup.subtitle});return i.field=new s("div",{className:"value"}),i.percentage=new s("div",{className:"percentage"}),t.append([i.percentage,new s("div",{className:"container"}).append([n,i.field,r])]),i}static regen(e,t){for(const s in e.gauges)e.gauges[s].sid==t.sid&&(e.gauges[s].destroy(),e.gauges[s]=K.gauge(t,t.source))}static include(e,t,i){t.source=new s("span");let n=new s("div").append([i.grab,i.remove,t.source]),r=new s("div",{sid:t.sid,className:"gauge tiny"}).append(n);e.muuri.add(r.$),e.gauges.push(K.gauge(t,t.source)),t.source.onevent("contextmenu",e,(t=>{t.preventDefault(),s.switchState(e.parent.$.dashboard)})),i.grab.onclick(e,e.edit,[t,r])}update(e){this.field.innerText=e;let t=(parseFloat(e)-this.minValue)/(this.maxValue-this.minValue)*100;t=t>100?100:t,t=t<0?0:t,this.percentage.style.marginTop=100-t+"%",this.percentage.style.height=`${t}%`}}class Y{constructor(e){this.actions=[];let t=this.$={};t.container=new s("span"),e.append(t.container)}show(e,t){this.deinit(),this.init(e,t)}init(e,t){let s=Y.defaults(e.type),i=Object.keys(s),n=Object.keys(e.setup);for(const t in s)n.includes(t)||(e.setup[t]=s[t]);for(const t in e.setup)i.includes(t)||delete e.setup[t];for(const s in e.setup){let i=new Z(e.setup[s],e,s,t);if(0!==Object.keys(i.$).length){this.actions.push(i),this.$.container.append(i.$.action)}else console.log(`Dashboard: When opening setup panel, ${s} was ignored.`)}}deinit(){this.actions.forEach((e=>{e.$.action.$.remove()})),this.actions=[]}static _getType(e,t){return{chart:{topic:"input",chartType:"dropdown",title:"input",source:"dropdown",labels:"input",timeseries:"switch",limitPoints:"input",xLabel:"input",yLabel:"input"},stream:{source:"dropdown",manifest:"input"},switch:{title:"input",subtitle:"input",target:"dropdown",topic:"input",messageOn:"input",messageOff:"input"},range:{title:"input",subtitle:"input",target:"dropdown",topic:"input",minValue:"input",maxValue:"input",step:"input"},gauge:{title:"input",subtitle:"input",source:"dropdown",topic:"input",minValue:"input",maxValue:"input"}}[e][t]}static defaults(e){switch(e){case"stream":return{source:"DASH",manifest:"https://livesim.dashif.org/livesim/chunkdur_1/ato_7/testpic4_8s/Manifest300.mpd"};case"chart":return{source:"EasyMQTT",topic:"data",chartType:"line",title:"",labels:"Variable 1, Variable 2",limitPoints:100,xLabel:"",yLabel:"",timeseries:!1};case"switch":return{target:"EasyMQTT",title:"Click",subtitle:"Me",topic:"button",messageOn:"turn_on",messageOff:"turn_off"};case"range":return{target:"EasyMQTT",title:"Range",subtitle:"Description",topic:"range",minValue:0,maxValue:100,step:1};case"gauge":return{source:"EasyMQTT",title:"Gauge",subtitle:"Unit",topic:"gauge",minValue:0,maxValue:100}}}static dict(e,t){return{chart:{topic:"Topic",chartType:["Chart type",["line","scatter","bar","pie","radar"]],title:"Title",source:["Source",["Console","EasyMQTT"]],labels:"Labels",timeseries:"Is Unix timestamp",limitPoints:"Limit to last datapoints",xLabel:"x-axis label",yLabel:"y-axis label"},stream:{source:["Standard",["MJPEG","DASH"]],manifest:"Manifest address"},switch:{target:["Target",["EasyMQTT","Console"]],title:"Title",subtitle:"Subtitle",topic:"Topic",messageOn:"Switch on message",messageOff:"Switch off message"},range:{target:["Target",["EasyMQTT","Console"]],title:"Title",subtitle:"Subtitle",topic:"Topic",minValue:"Lower bound",maxValue:"Upper bound",step:"Step"},gauge:{source:["Source",["EasyMQTT","Console"]],title:"Title",subtitle:"Subtitle",topic:"Topic",minValue:"Lower bound",maxValue:"Upper bound"}}[e][t]}}class Z{constructor(e,t,i,n){this.plugin=t.type,this.key=i,this.sid=t.sid,this.dom=t.target;let r=this.$={};switch(Y._getType(t.type,i)){case"button":r.action=new s("div",{className:"button"}),r.button=new s("button",{innerText:Y.dict(this.plugin,i),className:"noicon"}).onclick(this,this.do,[e.request]),r.action.append(r.button);break;case"input":r.action=new s("div",{className:"input"}),r.span=new s("span",{innerText:Y.dict(this.plugin,i)}),r.input=new s("input",{value:e}).onchange(this,this.input,[n,t]),r.action.append([r.span,r.input]);break;case"switch":r.action=new s("div",{className:e?"switch on":"switch"}),r.button=new s("button",{innerText:Y.dict(this.plugin,i),className:"noicon"}).onclick(this,this.switch,[n,t]),r.action.append(r.button);break;case"dropdown":let a=Y.dict(this.plugin,i),o=0;for(let t=0;t<a[1].length;t++)if(a[1][t]==e){o=t;break}r.action=new s("div",{className:"dropdown"}),r.span=new s("span",{innerText:a[0]}),r.dropdown=new s("select").onchange(this,this.dropdown,[n,t]),a[1].forEach((e=>{r.dropdown.append(new s("option",{value:e,innerText:e}))})),r.action.append([r.span,r.dropdown]),r.dropdown.$.selectedIndex=o}}switch(e,t){if(t.setup.timeseries=!t.setup.timeseries,this.$.action.$.className=t.setup.timeseries?"switch on":"switch","chart"===this.plugin)if("timeseries"===this.key)bipes.page.dashboard.commit(),H.regen(e.charts,t)}input(e,t){let s=String(this.$.input.$.value);switch(this.plugin){case"chart":switch(this.key){case"topic":case"title":case"labels":case"xLabel":case"yLabel":case"limitPoints":t.setup[this.key]=s,H.regen(e.charts,t),bipes.page.dashboard.commit()}case"stream":if("manifest"===this.key)t.setup.manifest=s,X.manifest(e,t),bipes.page.dashboard.commit();case"switch":switch(this.key){case"title":case"subtitle":case"topic":case"messageOn":case"messageOff":t.setup[this.key]=s,q.regen(e,t),bipes.page.dashboard.commit()}case"range":switch(this.key){case"title":case"subtitle":case"topic":case"minValue":case"maxValue":case"step":t.setup[this.key]=s,J.regen(e,t),bipes.page.dashboard.commit()}case"gauge":switch(this.key){case"title":case"subtitle":case"topic":case"source":case"minValue":case"maxValue":t.setup[this.key]=s,K.regen(e,t),bipes.page.dashboard.commit()}}}dropdown(e,t){let s=String(this.$.dropdown.$.value);switch(this.plugin){case"chart":switch(this.key){case"source":t.setup.source=s,H.regen(e.charts,t),bipes.page.dashboard.commit();break;case"chartType":t.setup.chartType=s,H.regen(e.charts,t),bipes.page.dashboard.commit()}case"switch":if("target"===this.key)t.setup.target=s,q.regen(e,t),bipes.page.dashboard.commit();case"stream":if("source"===this.key)t.setup.source=s,X.regen(e,t),bipes.page.dashboard.commit();case"range":if("target"===this.key)t.setup.target=s,J.regen(e,t),bipes.page.dashboard.commit();case"gauge":if("source"===this.key)t.setup.source=s,K.regen(e,t),bipes.page.dashboard.commit()}}switchState(e){this.currentValue}}class ee{constructor(e,t){this.parent=t,this.name="grid",this.ref,z.types.forEach((e=>this[e]=[])),this.editiding,this.editingProp,this.isGrabbing=[!1,void 0],this.chartBuffer,this.chartBufferInterval;let i=this.$={};i.grid=e,i.actions=new s("div",{id:"actions"}).append([new s("div",{className:"silk"}).onclick(this,this.closeEditor)]),i.silk=new s("div",{id:"silk"}).onclick(this,this.closeEditor),i.container=new s("div"),i.grid.append([i.silk,i.container,i.actions]),this.actions=new Y(i.actions),this.muuri=new Muuri(i.container.$,{layoutOnResize:!1,dragEnabled:!0,layoutOnInit:!1,dragHandle:"#grab",dragStartPredicate:(e,t)=>{if(this.parent.$.dashboard.classList.contains("on"))return this.isGrabbing=[+new Date,e._element.dataset.sid],!0}}).on("dragInit",(e=>{e._element.classList.add("grabbing")})).on("dragReleaseEnd",(e=>{if(e._element.classList.remove("grabbing"),+new Date-this.isGrabbing[0]<150&&this.isGrabbing[1]==e._element.dataset.sid){let t;this.ref.forEach((s=>{s.sid===e._element.dataset.sid&&(t=s)})),this.isGrabbing=[!1,void 0],this.edit(t,new s(e._element))}else this.isGrabbing=[!1,void 0]})).on("move",(()=>{this.storeLayout()})),this._css=document.createElement("style"),this._css.type="text/css",document.getElementsByTagName("head")[0].append(this._css),this._css.sheet.insertRule("section#dashboard .muuri .muuri-item.broad {}",0),this._css.sheet.insertRule("section#dashboard .muuri .muuri-item.square {}",0),this._css.sheet.insertRule("section#dashboard .muuri .muuri-item.wide {}",0),this._css.sheet.insertRule("section#dashboard .muuri .muuri-item.tiny {}",0),this.css={},this.css.muuriBroad=this._css.sheet.rules[3],this.css.muuriSquare=this._css.sheet.rules[2],this.css.muuriWide=this._css.sheet.rules[1],this.css.muuriTiny=this._css.sheet.rules[0],p.add([this.parent,this],{update:this._update},!0)}init(){this.chartBuffer={EasyMQTT:{},Console:{}},this.chartBufferInverval=setInterval((()=>{this.chartWatcher()}),250),this.ref=this.parent.tree[this.parent.currentSID].grid,this.restore()}deinit(){clearInterval(this.chartBufferInverval),delete this.chartBuffer.EasyMQTT,delete this.chartBuffer.Console,this.chartBuffer=void 0,this.$.grid.$.classList.remove("on"),this.editingPlugin="",setTimeout((()=>{this.actions.deinit()}),250),z.deinit(this),this.muuri.remove(this.muuri.getItems(),{removeElements:!0}),this.ref=void 0}restore(){this.ref.forEach((e=>{this.include(e)})),this.restoreLayout()}_update(e,t,s){s===D.currentUID&&(this.parent.tree[t].grid=e,t===this.parent.currentSID&&(this.deinit(),this.init()))}add(e){let t={sid:r.SID(),type:e,setup:Y.defaults(e)};this.ref.push(t),this.include(t),this.parent.commit()}include(e){let t={grab:new s("div",{id:"grab",title:Msg.DragMe}).onevent("contextmenu",this,(e=>{e.preventDefault(),this.parent.$.dashboard.classList.contains("on")||this.parent.$.dashboard.classList.add("on")})),remove:new s("button",{className:"button icon notext",id:"dismiss",title:Msg.DismissPlugin}).onclick(this,this.remove,[e]),silk:new s("div",{className:"silk"})};z.include(this,e,t)}remove(e){z.remove(this,e),this.editingPlugin==e.sid&&(this.$.grid.$.classList.remove("on"),this.editingPlugin="",setTimeout((()=>{this.actions.deinit}),250)),this.muuri.getItems().forEach(((t,s)=>{t._element.dataset.sid==e.sid&&this.muuri.remove([t],{removeElements:!0})})),this.ref.forEach(((t,s)=>{t.sid==e.sid&&this.ref.splice(s,1)})),this.parent.commit(),this.editing&&this.closeEditor()}edit(e,t,s){if(this.animating||null!=this.isGrabbing[1])return;t.id="editing",this.animating=this.editing=!0;let n=t.style.transform,r=parseFloat(n.match(/translateX\(([0-9]+\.?[0-9]*|\.[0-9]+)px\)/)[1]),a=parseFloat(n.match(/translateY\(([0-9]+\.?[0-9]*|\.[0-9]+)px\)/)[1]),o=t.width,c=t.height,[h,l,d,p]=this._computeEditorSize(e.type,[o,c]),u=0;t.style.zIndex="2",i.on(this.$.grid,125),this.bezier=setInterval((()=>{let e=u/15,s=e*e*(3-2*e),i=s*h+r*(1-s),n=s*l+a*(1-s);t.style.transform=`translateX(${i}px) translateY(${n}px)`,t.style.width=`${o+s*(d-o)}px`,t.style.height=`${c+s*(p-c)}px`,15==u++&&(clearInterval(this.bezier),this.animating=!1)}),15),this.actions.show(e,this),this.editing=e,this.editingProp={from:[r,a],to:[h,l],size_from:[o,c],size_to:[d,p],container:t},this.isGrabbing=[!1,void 0]}_computeEditorSize(e,t){let s,i,n,r;return"chart"==e?this.$.grid.width/16>40?(n=this.$.grid.width-272,r=this.$.grid.height-48):(n=this.$.grid.width-32,r=this.$.grid.height-240):(n=t[0],r=t[1]),this.$.grid.width/16>40?(s=(this.parent.$.section.width-n-240)/2,i=(this.parent.$.section.height-r)/2+this.$.grid.$.scrollTop-16):(s=(this.parent.$.section.width-n)/2,i=(this.parent.$.section.height-r)/2+this.$.grid.$.scrollTop-128),[s,i,n,r]}_refreshEditorSize(){let e=this.editingProp,[t,s,i,n]=this._computeEditorSize(this.editing.type,e.size_from);e.container.style.transform=`translateX(${t}px) translateY(${s}px)`,e.container.style.width=`${i}px`,e.container.style.height=`${n}px`,e.to=[t,s],e.size_to=[i,n]}closeEditor(){if(void 0===this.editing)return;this.animating=!0;let e=this.editingProp,t=0;this.bezier2=setInterval((()=>{let s=t/15,i=s*s*(3-2*s),n=i*e.from[0]+e.to[0]*(1-i),r=i*e.from[1]+e.to[1]*(1-i);e.container.style.transform=`translateX(${n}px) translateY(${r}px)`,e.container.style.width=`${e.size_to[0]+i*(e.size_from[0]-e.size_to[0])}px`,e.container.style.height=`${e.size_to[1]+i*(e.size_from[1]-e.size_to[1])}px`,15==t++&&(e.container.style.removeProperty("width"),e.container.style.removeProperty("height"),clearInterval(this.bezier2),this.animating=!1)}),15),i.off(this.$.grid,(()=>{e.container.style.zIndex="0",e.container.id="",this.editing=void 0,this.editingProp=void 0,setTimeout((()=>{this.resize()}),500)}),15)}resize(){if(this.$.grid.width/16>40?(this.$.actions.classList.add("broad"),this.$.actions.classList.remove("tall")):(this.$.actions.classList.add("tall"),this.$.actions.classList.remove("broad")),this.editing)return void this._refreshEditorSize();let e,t=this.$.container.width,s=this.$.grid.width/16,i=[[[t/3,t/6],[t/6,t/6],[t/12,t/12]],[[t/2,t/4],[t/4,t/4],[t/8,t/8]],[[t/1.5,t/3],[t/3,t/3],[t/6,t/6]],[[t/1,t/2],[t/2,t/2],[t/4,t/4]]];e=s>80?0:s>60?1:s>40?2:3,this.css.muuriBroad.style.width=i[e][0][0]-1+"px",this.css.muuriBroad.style.height=`${i[e][0][1]}px`,this.css.muuriSquare.style.width=i[e][1][0]-1+"px",this.css.muuriSquare.style.height=`${i[e][1][1]}px`,this.css.muuriWide.style.width=i[e][1][0]-1+"px",this.css.muuriWide.style.height=`${i[e][2][1]}px`,this.css.muuriTiny.style.width=i[e][2][0]-1+"px",this.css.muuriTiny.style.height=`${i[e][2][1]}px`,this.muuri.refreshItems().layout()}storeLayout(){let e=this.muuri.getItems().map((e=>e.getElement().dataset.sid));this.ref.forEach(((t,s)=>{t.pos=e.indexOf(t.sid)})),this.parent.commit()}restoreLayout(){let e=this.muuri.getItems(),t=e.map((e=>e.getElement().dataset.sid)),s=[],i=[];this.ref.forEach(((n,r)=>{null==n.pos?i.push(e[t.indexOf(n.sid)]):s[n.pos]=e[t.indexOf(n.sid)]})),s=s.filter((e=>e)),s.push(...i),this.muuri.sort(s,{layout:"instant"})}chartsPush(e,t,s,i){this.chartBuffer[i].hasOwnProperty(e)||(this.chartBuffer[i][e]={refresh:!1,coord:[]}),this.chartBuffer[i][e].coord.push(t),s&&(this.chartBuffer[i][e].refresh=!0)}chartWatcher(){if(void 0!==this.chartBuffer)for(const e of["EasyMQTT","Console"])for(const t in this.chartBuffer[e])this.charts.forEach((s=>{s.source===e&&s.topic==t&&(this.chartBuffer[e][t].refresh?this.ref.forEach((e=>{e.sid===s.sid&&z.regen(this.charts,e)})):(this.chartBuffer[e][t].coord.forEach((e=>{s.data.labels.push(e[0]),s.data.datasets.forEach(((t,s)=>{t.data.push(e[s+1])}))})),s.hasOwnProperty("limitPoints")&&s.data.labels.length>s.limitPoints&&(s.data.labels.splice(0,this.chartBuffer[e][t].coord.length),s.data.datasets.forEach(((s,i)=>{s.data.splice(0,this.chartBuffer[e][t].coord.length)}))),s.update()))})),delete this.chartBuffer[e][t]}regenCharts(e){this.charts.forEach((t=>{this.ref.forEach((s=>{s.sid===t.sid&&s.setup.source==e&&z.regen(this.charts,s)}))}))}gaugesPush(e,t,s){this.gauges.forEach((i=>{i.topic==e&&i.source==s&&i.update(t)}))}}class te{constructor(e,t,i){this.grid=t,this.plugins={chart:"Chart",switch:"Switch",range:"Range",gauge:"Gauge"};let n=this.$={};n.addMenu=e,n.addMenu.onclick(this,this.close),n.plugins=[];for(const e in this.plugins)n.plugins.push(new s("button",{value:e,id:`${e}`,className:"icon",innerText:this.plugins[e]}).onclick(t,t.add,[e]));n.wrapper=new s("div").append(n.plugins),n.addMenu.append(n.wrapper),i.onclick(this,this.open)}close(e){"addMenu"==e.target.id&&i.off(this.$.addMenu.$)}open(){i.on(this.$.addMenu.$)}}class se{constructor(e,t,i,n){this.datalake=[],this.datalakeMQTT=[],this.parent=n,this.name="storagemanager",this.bridgeEasyMQTT=new ie;let r=this.$={};r.storageManager=e,r.storageManager.onclick(this,this.close),r.upload=new s("input",{id:"uploadCSV",type:"file",accept:".csv"}).onchange(this,this.uploadCSV),r.uploadLabel=new s("label",{className:"button icon notext",id:"upload",title:"Upload CSV",htmlFor:"uploadCSV"}),r.h2=new s("h2",{innerText:"Console (localStorage)"}),r.title=new s("div",{className:"header"}).append([r.h2,r.upload,r.uploadLabel]),r.container=new s("span",{className:"list"}),r.mqttH2=new s("h2",{innerText:"EasyMQTT"}),r.mqttInput=new s("input",{placeholder:Msg.Session,id:"mqttSession",value:W.session}).onevent("change",this,this.changeMQTTSession),r.mqttTitle=new s("div",{className:"header"}).append([r.mqttH2,r.mqttInput]),r.containerMQTT=new s("span",{className:"list"}),r.wrapper=new s("div").append([r.mqttTitle,r.containerMQTT,r.title,this.bridgeEasyMQTT.$.container,r.container]),r.storageManager.append(r.wrapper),this.ref=t,r.statusMQTT=new s("div"),r.statusMQTT.innerText=W.session,r.statusMQTTButton=new s("button",{className:"status-icon",id:"mqtt",title:Msg.MQTTSession}).append(r.statusMQTT).onclick(this,(()=>{this.parent.nav.click(),this.open(),r.mqttInput.$.focus()})),new s(s.get("div#status-bar #globals")).append([r.statusMQTTButton]),p.add([this.parent,this],{changedMQTTSession:this._changedMQTTSession}),i.onclick(this,this.open)}changeMQTTSession(){let e=this.$.mqttInput.value;e=""==e?r.SID():e,e=/[0-9]/.test(e[0])?`${r.randomChar()}${e.substring(1)}`:e,e=e.substring(0,16),p.dispatch([this.parent,this],"changedMQTTSession",[e]),u.set("mqtt_session",e)}_changedMQTTSession(e){W.session=e,this.$.statusMQTT.innerText=W.session,this.$.mqttInput.value=W.session,V.reinit(),this.deinit(),this.restore()}close(e){"storageManager"==e.target.id&&(this.$.wrapper.style.marginTop="110vh",i.off(this.$.storageManager.$,(()=>{this.deinit()})))}open(){this.restore();let e=this.$;setTimeout((()=>{e.wrapper.style.marginTop=window.innerWidth/16>40?"10vh":`calc(${window.innerHeight}px - 20.5rem)`}),125),i.on(e.storageManager.$,125)}restore(){u.keys(/datastorage:(.*)/).forEach((e=>{this.include(e)})),d.isLocal||V.do(`${W.session}/ls`).then((e=>{e.hasOwnProperty(W.session)&&e[W.session].forEach((e=>{this.includeMQTT(e.topic)}))}))}include(e){let t=new s("button",{className:"icon notext",id:"remove",title:Msg.DeleteData}),i=new s("button",{className:"icon notext",id:"download",title:Msg.DownloadCSV}).onclick(this,this.download,[e]),n=new s("div").append([i,t]),r=new s("div",{id:e,innerText:e}).append([n]);this.datalake.push(r),t.onclick(this,this.remove,[e,r]),this.$.container.append(r)}includeMQTT(e){let t=new s("button",{className:"icon notext",id:"remove",title:Msg.DeleteData}),i=new s("button",{className:"icon notext",id:"download",title:Msg.DownloadCSV}).onclick(this,this.downloadMQTT,[e]),n=new s("div").append([i,t]),r=new s("div",{id:e,innerText:e}).append([n]);this.datalakeMQTT.push(r),t.onclick(this,this.removeMQTT,[e,r]),this.$.containerMQTT.append(r)}deinit(){this.datalake.forEach((e=>{e.$.remove()})),this.datalake=[],this.datalakeMQTT.forEach((e=>{e.$.remove()})),this.datalakeMQTT=[]}remove(e,t){t.$.remove(),this.datalake.forEach(((t,s)=>{t.$.id==e&&(t.$.remove(),this.datalake.splice(s,1))})),u.remove(`datastorage:${e}`),Q.remove(e),null!=this.ref&&this.ref.charts.forEach((t=>{t.topic==e&&"Console"==t.source&&this.ref.ref.forEach((e=>{e.sid===t.sid&&z.regen(this.ref.charts,e)}))}))}removeMQTT(e){V.do(`${W.session}/${e.replaceAll("/","$")}/rm`).then((t=>{t.hasOwnProperty(W.session)&&(this.datalakeMQTT.forEach(((t,s)=>{V.remove(e),t.$.id==e&&(t.$.remove(),this.datalakeMQTT.splice(s,1))})),null!=this.ref&&this.ref.charts.forEach((t=>{t.topic==e&&"EasyMQTT"==t.source&&this.ref.ref.forEach((e=>{e.sid===t.sid&&z.regen(this.ref.charts,e)}))})))}))}exportCSV(e){return u.fetch(`datastorage:${e}`).replaceAll("],[","\r\n").replace("]]","").replace("[[",`"BIPES","Dashboard"\r\n"Data:","${e}"\r\n"Timestamp:","${String(+new Date)}"\r\n`)}organizeJSON(e,t,s){let i=[],n={};return n.session={name:e,timestamp:+new Date},s.forEach((e=>{i.push(e.data)})),n.session.topic={name:t,data:i},JSON.stringify(n,null,2)}downloadMQTT(e){V.do(`${W.session}/${e.replaceAll("/","$")}/grep`).then((t=>{if(t.hasOwnProperty(W.session)){let s=this.organizeJSON(W.session,e,t[W.session]),i="data:application/json;charset=utf-8,"+encodeURIComponent(s),n=document.createElement("a");n.setAttribute("href",i),n.setAttribute("download",`${W.session}_${e}.bipes.json`),n.style.display="none",document.body.appendChild(n),n.click(),document.body.removeChild(n)}}))}download(e){let t=this.exportCSV(e),s="data:text/csv;charset=utf-8,"+encodeURIComponent(t),i=document.createElement("a");i.setAttribute("href",s),i.setAttribute("download",`${e}.bipes.csv`),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)}uploadCSV(){let e=this.$.upload.$;if(null!=e.files[0]){let t=e.files[0];if(/.csv$/.test(t.name)&&"text/csv"==t.type){let s=new FileReader;s.readAsText(t,"UTF-8"),s.onload=s=>{let i,n=s.target.result.split(/\r\n|\n/);if(/^"BIPES","Databoard"/.test(n[0])?(/^"Data:","(.*)"/.test(n[1])&&(i=n[1].match(/"Data:","(.*)"/m)[1]),n.splice(0,3)):i=t.name.replace(".csv",""),n.forEach(((e,t)=>{n[t]=n[t].split(","),n[t].forEach(((e,s)=>{n[t][s].includes('"')?n[t][s]=n[t][s].replaceAll('"',""):n[t][s]=parseFloat(n[t][s])}))})),n=n.filter((e=>e.length>1)),u.has(`datastorage:${i}`)){let e=!1,t=1;for(;!e;)u.has(`datastorage:${i}_${t}`)?t++:(u.set(`datastorage:${i}_${t}`,JSON.stringify(n)),e=!0)}else u.set(`datastorage:${i}`,JSON.stringify(n));this.deinit(),this.restore(),e=""}}}}onConnect(){this.$.statusMQTTButton.classList.add("on"),this.$.statusMQTTButton.classList.remove("off"),this.$.mqttH2.classList.add("on"),this.$.mqttH2.classList.remove("off")}onConnectionLost(){this.$.statusMQTTButton.classList.remove("on"),this.$.statusMQTTButton.classList.add("off"),this.$.mqttH2.classList.remove("on"),this.$.mqttH2.classList.add("off")}}class ie{constructor(){this.status=!1;let e=this.$={};[e.input,e.container]=s.prototypeCheckSwitch({id:"bridgeEasyMQTT",className:"bridgeEasyMQTT",innerText:Msg.BridgeDataToEasyMQTT}),e.input.onevent("change",this,this.switch)}switch(){this.status=!this.status}}let ne=new class{constructor(){this.name="dashboard",this.inited=!1,this.tree,this.easyMQTT=W;let e=this.$={};e.dashboard=new s("div",{id:"dashboard"}),e.grid=new s("div",{id:"grid"}),e.header=new s("div",{id:"header"}),e.storageManager=new s("div",{id:"storageManager",className:"popup"}),e.addMenu=new s("div",{id:"addMenu",className:"popup"}),e.dashboard.append([e.header,e.grid,e.storageManager,e.addMenu]),e.contextMenu=new s("div"),this.contextMenu=new n(e.contextMenu,this),e.section=new s(s.get("section#dashboard")).append([e.dashboard,e.contextMenu]),e.add=new s("button",{className:"icon",id:"add",title:Msg.NewDashboard}).onclick(this,this.add,[!0]),e.storage=new s("button",{className:"icon",id:"storage",title:Msg.EditData}),e.addPlugin=new s("button",{className:"icon",id:"add",title:Msg.AddWidget}),e.edit=new s("button",{className:"icon",id:"edit",title:Msg.EditDashboard}).onclick(this,(()=>{e.dashboard.classList.contains("on")?(e.dashboard.classList.remove("on"),this.grid.closeEditor()):e.dashboard.classList.add("on")}),[!0]),e.tabs=new s("span",{id:"tabs"}),e.wrapper=new s("div").append([e.tabs,e.add]),e.wrapper2=new s("span").append([e.edit,e.storage]),e.header.append([e.wrapper,e.wrapper2]),this.grid=new ee(e.grid,this),e.grid.append([e.addPlugin]),this.storagemanager=new se(e.storageManager,this.grid,e.storage,this),this.addMenu=new te(e.addMenu,this.grid,e.addPlugin),z.init(),p.add(this,{add:this._add,remove:this._remove,rename:this._rename})}init(){this.inited||(this.tree instanceof Array&&(this.tree={}),0===Object.keys(this.tree).length&&this.add(),this.restore(),this.select(Object.keys(this.tree)[0]),Q.init(this.grid),V.init(this.grid),this.inited=!0)}deinit(){this.inited&&(this.unselect(),this.$.tabs.removeChilds(),Q.deinit(),V.deinit(),this.inited=!1)}write(e){Q.write(e,this.storagemanager.bridgeEasyMQTT.status)}load(e){if(!e.hasOwnProperty("tree"))return;let t=this.inited;this.inited&&this.deinit(),this.tree=e.tree,t&&this.init()}restore(){for(const e in this.tree)this.include(e,this.tree[e])}resize(){this.grid.resize()}empty(){return{tree:{}}}include(e,t){let i=new s("h3",{innerText:t.name});t.dom=new s("button",{sid:e}).append([i]).onevent("contextmenu",this,(s=>{s.preventDefault(),this.contextMenu.open([{id:"rename",innerText:Msg.Rename,fun:this.rename,args:[e,t.name]},{id:"remove",innerText:Msg.Remove,fun:this.remove,args:[e]}],s)})).onclick(this,this.select,[e]),this.$.tabs.append(t.dom)}commit(){D.write(),p.dispatch([this,this.grid],"update",[this.grid.ref,this.currentSID,D.currentUID])}add(e){let t=r.SID();p.dispatch(this,"add",[t,D.currentUID]),D.write(),!0===e&&this.select(t)}_add(e,t){if(t!==D.currentUID)return;let s={grid:[],name:Msg.Dashboard};this.tree[e]=s,this.inited&&this.include(e,s)}remove(e){this.contextMenu.close(),p.dispatch(this,"remove",[e,D.currentUID]),D.write()}_remove(e,t){t===D.currentUID&&(this.inited&&(e===this.currentSID&&(this.unselect(),1==Object.keys(this.tree).length&&this.add()),s.get(`[data-sid='${e}']`,this.$.tabs).remove()),delete this.tree[e],null==this.currentSID&&this.select(Object.keys(this.tree)[0]))}rename(e,t){this.contextMenu.oninput({title:Msg.DashboardName,placeholder:t,value:t},((t,s)=>{s.preventDefault();let i=t.value;this.contextMenu.close(),null!=i&&""!=i&&(this.tree[e].name=i,p.dispatch(this,"rename",[e,i,D.currentUID]),D.write())}))}_rename(e,t,i){i===D.currentUID&&(this.inited&&(s.get(`[data-sid='${e}'] h3`,this.$.tabs).innerText=t),this.tree[e].name=t)}select(e){void 0!==this.currentSID&&this.unselect(),this.currentSID=e,this.grid.init(),s.get(`[data-sid='${e}']`,this.$.tabs).classList.add("on")}unselect(){this.grid.deinit(),s.get(`[data-sid='${this.currentSID}']`,this.$.tabs).classList.remove("on"),this.currentSID=void 0}},re={};return re.en="English",re["pt-br"]="Brazilian Portuguese",re.de="German",re.es="Spanish",re.fr="French",re.it="Italian",re.nb="Norwegian",re["zh-hans"]="Chinese (simplified)",re["zh-hant"]="Chinese (traditional)",function(){window.bipes={},bipes.theme="",bipes.lang="",bipes.page={},bipes.rosetta=t,bipes.navigation=d,bipes.command=p,bipes.storage=u,bipes.channel=w,bipes.page.prompt=v,bipes.page.device=S,bipes.page.blocks=R,bipes.page.files=I,bipes.page.notification=$,bipes.page.dashboard=ne,bipes.page.project=D,bipes.navigation=d,bipes.page.project._init(),bipes.navigation.init(re)}}));
